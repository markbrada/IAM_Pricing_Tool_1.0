<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>In A Minnit Pricing Tool 1.0</title>
  <style>
    /* Overall Page */
    body {
      font-family: sans-serif;
      margin: 1rem;
      background-color: #f7f7f7; 
    }

    h1 {
      margin-bottom: 0.2rem;
    }
    p {
      margin-top: 0;
      margin-bottom: 2rem;
    }

    /* Basket Container near the top */
    #basketContainer {
      display: none; /* hidden if empty */
      background-color: #fff;
      padding: 1rem;
      margin-bottom: 2rem; /* space after the basket */
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    #basketContainer h3 {
      margin-top: 0;
      margin-bottom: 1rem;
    }

    /* Basket Table */
    #basketTable {
      width: 100%;
      border-collapse: collapse;
    }
    #basketTable thead tr {
      background-color: #e0e0e0; /* light grey header row */
    }
    #basketTable th,
    #basketTable td {
      border: 1px solid #ddd;
      padding: 0.5rem;
      text-align: center;
    }
    /* Make line total columns a lighter grey */
    /* We'll do it by a CSS class on those cells */
    .line-total-cell {
      background-color: #f3f3f3; 
    }
    .basket-actions button {
      margin-right: 0.5rem;
      background-color: #17a2b8; 
      color: #fff;
      border: none;
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      cursor: pointer;
    }
    .basket-actions button:hover {
      background-color: #138496;
    }
    .remove-btn {
      color: #dc3545; 
      font-weight: bold;
      cursor: pointer;
    }
    .remove-btn:hover {
      text-decoration: underline;
    }

    /* Quantity controls */
    .qty-controls {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .qty-controls button {
      margin: 0 5px;
      background-color: #6c757d; 
      color: #fff;
      border: none;
      padding: 0.2rem 0.6rem;
      border-radius: 3px;
      cursor: pointer;
    }
    .qty-controls button:hover {
      background-color: #5a6268;
    }
    .qty-input {
      width: 60px;
      text-align: center;
      padding: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    /* Sheet Buttons */
    #sheetButtons > button {
      margin-right: 0.5rem;
      background-color: #007bff; 
      color: #fff;
      border: none;
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      cursor: pointer;
    }
    #sheetButtons > button:hover {
      background-color: #0056b3; 
    }

    /* Container for each sheet's table + search */
    .sheet-view {
      background-color: #fff; 
      padding: 1rem;
      border-radius: 5px;
      margin-bottom: 2rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* Search filter box */
    .search-container {
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
    }
    .search-label {
      font-weight: bold;
      margin-right: 0.5rem;
      color: #333;
    }
    .search-input {
      padding: 0.4rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 200px;
    }

    /* Table styling */
    table {
      border-collapse: collapse;
      width: 100%;
      background-color: #fff;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.5rem;
      cursor: default;
    }
    tbody tr:hover {
      background-color: #f9f9f9;
    }
    td:active {
      background-color: #eaeaea;
    }

    /* “+” button on the far LEFT in the main table */
    .add-button {
      background-color: #28a745; 
      border: none;
      color: #fff;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    .add-button:hover {
      background-color: #218838; 
    }
  </style>
</head>
<body>

<h1>In A Minnit Pricing Tool 1.0</h1>
<p><em>Beta version - we appreciate your feedback!</em></p>

<!-- BASKET AT THE TOP -->
<div id="basketContainer">
  <h3>Quote Basket</h3>
  <div class="basket-actions">
    <!-- Removed PDF export; renamed CSV export -->
    <button id="exportCsvBtn">Export quote CSV</button>
  </div>
  <table id="basketTable">
    <thead>
      <tr>
        <th>Item</th>
        <th>Quantity</th>
        <th>Price Ex. GST</th>
        <th>Price Inc. GST</th>
        <th>Line Total Ex. GST</th>
        <th>Line Total Inc. GST</th>
        <th>Remove</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <p><strong>Grand Total (Ex. GST):</strong> $<span id="grandEx">0.00</span></p>
  <p><strong>Grand Total (Inc. GST):</strong> $<span id="grandInc">0.00</span></p>
</div>

<!-- SHEET BUTTONS AND TABLES BELOW -->
<div id="sheetButtons"></div>
<div id="sheetContainer"></div>

<!-- SheetJS library -->
<script src="xlsx.full.min.js"></script>
<!-- We removed jsPDF since we're not exporting PDF anymore -->

<script>
/* ------------------------------------------------------------------
  CONFIG
------------------------------------------------------------------ */
const PRICE_COLUMNS_EX = ["Rate Ex. GST", "Price Ex. GST"];
const PRICE_COLUMN_INC = "Price Inc. GST";

/* ------------------------------------------------------------------
  GLOBALS
------------------------------------------------------------------ */
// We'll store each item as:
// { itemName, quantity, exPrice, incPrice }
let basket = [];

/* DOM Elements */
const sheetButtons = document.getElementById("sheetButtons");
const sheetContainer = document.getElementById("sheetContainer");
const basketContainer = document.getElementById("basketContainer");
const basketTableBody = document.querySelector("#basketTable tbody");
const grandExEl = document.getElementById("grandEx");
const grandIncEl = document.getElementById("grandInc");
const exportCsvBtn = document.getElementById("exportCsvBtn");

/* ------------------------------------------------------------------
  FETCH & PARSE EXCEL
------------------------------------------------------------------ */
fetch("myFile.xlsx")
  .then(response => response.arrayBuffer())
  .then(data => {
    const workbook = XLSX.read(data, { type: "array" });
    Object.keys(workbook.Sheets).forEach(sheetName => {
      const btn = document.createElement("button");
      btn.textContent = sheetName;
      btn.onclick = () => showSheet(workbook, sheetName);
      sheetButtons.appendChild(btn);
    });
  })
  .catch(err => {
    console.error("Failed to fetch Excel file:", err);
    sheetContainer.textContent = "Error fetching Excel file.";
  });

/* ------------------------------------------------------------------
  SHOW SHEET WITH SEARCH & BASKET BTN
------------------------------------------------------------------ */
function showSheet(workbook, sheetName) {
  const sheet = workbook.Sheets[sheetName];
  const rows = XLSX.utils.sheet_to_json(sheet, {
    header: 1,
    defval: "",
    blankrows: true
  });

  // Pad columns
  const maxCols = Math.max(...rows.map(r => r.length));
  rows.forEach(row => {
    while (row.length < maxCols) row.push("");
  });

  sheetContainer.innerHTML = "";
  const wrapper = document.createElement("div");
  wrapper.classList.add("sheet-view");
  sheetContainer.appendChild(wrapper);

  // Search bar container
  const searchDiv = document.createElement("div");
  searchDiv.classList.add("search-container");
  const searchLabel = document.createElement("label");
  searchLabel.classList.add("search-label");
  searchLabel.textContent = "Search items:";
  const searchInput = document.createElement("input");
  searchInput.type = "text";
  searchInput.placeholder = "Type to filter...";
  searchInput.classList.add("search-input");

  searchDiv.appendChild(searchLabel);
  searchDiv.appendChild(searchInput);
  wrapper.appendChild(searchDiv);

  const tableContainer = document.createElement("div");
  wrapper.appendChild(tableContainer);

  const headers = rows.length > 0 ? rows[0].map(h => String(h).trim()) : [];

  function buildTable(filteredRows) {
    tableContainer.innerHTML = "";
    const table = document.createElement("table");
    const tbody = document.createElement("tbody");

    filteredRows.forEach((row, rowIndex) => {
      const tr = document.createElement("tr");

      if (rowIndex > 0) {
        // ADD BUTTON ON THE FAR LEFT
        const addCell = document.createElement("td");
        const addBtn = document.createElement("button");
        addBtn.classList.add("add-button");
        addBtn.textContent = "+";
        addBtn.onclick = () => addToBasket(row, headers);
        addCell.appendChild(addBtn);
        tr.appendChild(addCell);
      } else {
        // If it's the header row, insert an empty cell for the + column
        const blankCell = document.createElement("td");
        blankCell.style.fontWeight = "bold";
        blankCell.textContent = "";
        tr.appendChild(blankCell);
      }

      row.forEach((cellValue, colIndex) => {
        const td = document.createElement("td");
        // If it's the header row, maybe bold
        if (rowIndex === 0) {
          td.style.fontWeight = "bold";
        }
        td.textContent = formatIfPrice(rowIndex, headers[colIndex], cellValue);

        // click to copy
        td.onclick = () => {
          navigator.clipboard.writeText(td.textContent)
            .then(() => console.log("Copied:", td.textContent))
            .catch(err => console.error("Clipboard error:", err));
        };

        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    tableContainer.appendChild(table);
  }

  buildTable(rows);

  // Filter
  searchInput.addEventListener("input", () => {
    const val = searchInput.value.trim().toLowerCase();
    if (!val) {
      buildTable(rows);
      return;
    }
    const filtered = rows.filter((r, i) => {
      if (i === 0) return true; // keep header
      return r.some(cell => String(cell).toLowerCase().includes(val));
    });
    buildTable(filtered);
  });
}

function formatIfPrice(rowIndex, colHeader, cellValue) {
  if (rowIndex === 0) return cellValue; 
  const lower = (colHeader || "").toLowerCase();
  if (lower.includes("ex. gst") || lower.includes("inc. gst")) {
    const parsed = parseFloat(cellValue);
    if (!isNaN(parsed)) {
      return parsed.toFixed(2);
    }
  }
  return cellValue; 
}

/* ------------------------------------------------------------------
  ADD TO BASKET (ex/inc GST)
------------------------------------------------------------------ */
function addToBasket(row, headers) {
  const itemName = row[0] || "Untitled";
  let exPrice = null;
  let incPrice = null;

  for (let i = 0; i < headers.length; i++) {
    const head = headers[i];
    const val = parseFloat(row[i]);
    if (PRICE_COLUMNS_EX.includes(head)) {
      if (!isNaN(val)) exPrice = val;
    }
    if (head === PRICE_COLUMN_INC) {
      if (!isNaN(val)) incPrice = val;
    }
  }

  const existing = basket.find(it => it.itemName === itemName);
  if (existing) {
    existing.quantity = parseFloat(existing.quantity) + 1;
  } else {
    basket.push({
      itemName,
      quantity: 1,
      exPrice,
      incPrice
    });
  }
  renderBasket();
}

function renderBasket() {
  if (basket.length === 0) {
    basketContainer.style.display = "none";
    return;
  }
  basketContainer.style.display = "block";
  basketTableBody.innerHTML = "";

  let totalEx = 0;
  let totalInc = 0;

  basket.forEach((item, index) => {
    const tr = document.createElement("tr");

    // Item
    const nameTd = document.createElement("td");
    nameTd.textContent = item.itemName;
    tr.appendChild(nameTd);

    // Quantity (with +/-)
    const qtyTd = document.createElement("td");
    const qtyControls = document.createElement("div");
