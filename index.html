<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<meta charset="UTF-8">
<title>In A Minnit Pricing Tool 1.2</title>
<style>
/* === theme, layout, tables, basket, toast — identical to previous version (with small fixes) === */
:root{--bg:#f7f7f7;--fg:#333;--header:#e0e0e0;--btn:#007bff;--btnh:#0056b3;
--add:#28a745;--addh:#218838;--border:#aaa;--alt:#f9f9f9;--panel:#fff;
--toast:#007bff;--toastfg:#fff;--rowHover:#e9f1ff}
.dark-mode{--bg:#222;--fg:#eee;--header:#444;--btn:#0d6efd;--btnh:#0a58ca;
--add:#198754;--addh:#157347;--border:#555;--alt:#2a2a2a;--panel:#333;
--toast:#0d6efd;--toastfg:#fff;--rowHover:#383838}
body{font-family:sans-serif;margin:1rem;background:var(--bg);color:var(--fg);transition:.3s}
h1{margin:.2rem 0}p{margin:0 0 2rem}
#darkModeToggle{position:fixed;top:10px;right:10px;z-index:3000;background:var(--btn);
color:#fff;border:none;padding:.5rem .75rem;border-radius:4px;cursor:pointer}
#darkModeToggle:hover{background:var(--btnh)}
#sheetTabs{border-bottom:1px solid var(--border);margin-bottom:1rem}
#sheetTabs button{background:none;border:none;padding:.5rem 1rem;margin-right:.5rem;
cursor:pointer;font-size:1rem;color:var(--fg)}
#sheetTabs button.active{border-bottom:2px solid var(--btn);font-weight:bold}
/* Keep light text for tabs in dark mode unless the button itself has a light bg; summaries below are forced to black for readability */
/* .dark-mode #sheetTabs button{color:#000}  — uncomment if your tab buttons have a light/yellow bg */
.search-container{margin-bottom:1rem;padding:.5rem;background:var(--panel);
border:1px solid var(--border);border-radius:4px}
.search-label{font-weight:bold;margin-right:.5rem}
.search-input{padding:.4rem;border:1px solid var(--border);border-radius:4px;
width:200px;background:var(--panel);color:var(--fg)}
.highlight{background:yellow}

/* === tables === */
table{border-collapse:collapse;width:100%}
thead th{position:sticky;top:0;background:var(--header);border:1px solid var(--border);
padding:.5rem;text-align:center;z-index:2}
tbody td{border:1px solid var(--border);padding:.5rem}
/* Removed zebra striping so hover applies uniformly */
/* tbody tr:nth-child(even){background:var(--alt)!important} */
tbody tr{background:transparent}
tbody tr:hover{background:var(--rowHover)}

.add-button{background:var(--add);color:#fff;border:none;padding:.3rem .6rem;
border-radius:4px;font-weight:bold;cursor:pointer}
.add-button:hover{background:var(--addh)}
.copied-cell{background:#c8e6c9!important;transition:.15s}

/* details/summary category blocks */
details{margin-bottom:1rem}
summary{list-style:none;cursor:pointer;display:flex;align-items:center;gap:.5rem;
padding:.4rem .6rem;border-radius:4px;background:var(--header);font-weight:bold}
summary::-webkit-details-marker{display:none}
summary:hover{background:var(--btn);color:#fff}
/* Force dark-mode text to black on light category headers (yellow/red/orange/blue/brown) */
.dark-mode summary{color:#000}
.dark-mode summary:hover{color:#fff}
.cat-orange summary{background:#ffe9d6}.cat-orange summary:hover{background:#ffc999;color:#000}
.cat-blue   summary{background:#d8ebff}.cat-blue   summary:hover{background:#add6ff;color:#000}
.cat-brown  summary{background:#f2e6d9}.cat-brown  summary:hover{background:#e0cbb9;color:#000}
.cat-red    summary{background:#ffdede}.cat-red    summary:hover{background:#ffb7b7;color:#000}
.cat-yellow summary{background:#fff8d6}.cat-yellow summary:hover{background:#ffea9f;color:#000}

/* === basket === */
#basketContainer{position:fixed;bottom:0;left:0;right:0;max-height:40%;
background:var(--panel);border-top:1px solid var(--border);padding:1rem;
box-shadow:0 -2px 5px rgba(0,0,0,.1);z-index:1000;overflow-y:auto}
#basketHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}
#basketHeader h3{margin:0}
#basketHeader button{background:var(--btn);color:#fff;border:none;padding:.3rem .6rem;
border-radius:4px;cursor:pointer}
#basketHeader button:hover{background:var(--btnh)}
#basketTable th,#basketTable td{border:1px solid var(--border);padding:.5rem}
/* Removed basket zebra as well for consistency */
/* #basketTable tbody tr:nth-child(even){background:var(--alt)!important} */
#basketTable tbody tr:hover{background:var(--rowHover)}
.sort-handle{cursor:move;user-select:none;text-align:center;font-size:1.2rem;width:2em}
.qty-input{width:60px;text-align:center}
.remove-btn{color:red;font-weight:bold;cursor:pointer}
#toast{margin-left:1rem;background:var(--toast);color:var(--toastfg);
padding:.3rem .6rem;border-radius:4px;opacity:0;transition:.3s}
#toast.show{opacity:1}
/* editable inputs in basket */
.editable{background:#fff;border:1px solid var(--border);padding:.2rem .3rem;border-radius:4px}
.item-input{width:100%}
.price-input{max-width:110px;text-align:right}

/* editable inputs in basket */
.editable{background:#ffe0ff;border:1px solid var(--border);padding:.2rem .3rem;border-radius:4px}
.item-input{width:100%}
.price-input{max-width:110px;text-align:right}
.gst-cell{ text-align:center }
.gst-input{ width:18px; height:18px }

/* expander + details */
.expander{background:none;border:1px solid var(--border);border-radius:4px;padding:.1rem .35rem;cursor:pointer}
.details-row td{background:var(--panel)}
.details-panel{padding:.75rem;border-top:1px dashed var(--border);background:var(--alt)}
.details-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:.75rem}
.details-grid .notes{grid-column:1/-1}
.details-grid .line-note{grid-column:1/-1}
.details-panel label{font-weight:bold;font-size:.85rem;display:block;margin-bottom:.25rem}
.details-panel .ro{padding:.45rem .6rem;border:1px solid var(--border);border-radius:4px;background:var(--panel)}
.hours-input,.line-note-input{width:100%;border:1px solid var(--border);border-radius:4px;padding:.3rem;background:#fff}
.dup-btn{background:var(--btn);color:#fff;border:none;padding:.3rem .6rem;border-radius:4px;cursor:pointer}
.dup-btn:hover{background:var(--btnh)}

</style>
</head>
<body>
<h1>In A Minnit Pricing Tool 1.2</h1>
<p><em>Beta version – features subject to change. Always check your work. Report bugs to marco@inaminnit.com.au</em></p>
<button id="darkModeToggle">Toggle Dark Mode</button>

<div id="sheetTabs"></div>
<div id="status" style="margin:.5rem 0;font-size:.9rem"></div>
<div id="manualLoad" style="display:none;margin:.5rem 0">
  <label class="search-label">Load workbook:</label>
  <input type="file" id="xlsxPicker" accept=".xlsx">
</div>
<div id="sheetContainer"></div>

<!-- =====  BASKET  ===== -->
<div id="basketContainer">
  <div id="basketHeader">
    <div style="display:flex;align-items:center;gap:.5rem">
      <h3>Quote Basket</h3><span id="toast"></span>
    </div>
    <div>
      <button id="addCustomBtn">Add custom line</button>
      <button id="clearBasketBtn">Clear</button>
      <button id="exportCsvBtn">Export quote CSV</button>
      <button id="toggleBasketBtn">Hide Basket</button>
    </div>
  </div>
  <div id="basketContent">
    <table id="basketTable">
      <thead><tr>
        <th class="sort-handle">≡</th><th>Item</th><th>Quantity</th>
        <th>Price Ex. GST</th><th>GST Apply</th>
        <th>Line Total Ex. GST</th><th>GST</th><th>Line Total</th><th>Remove</th>
      </tr></thead>
      <tbody></tbody><tfoot></tfoot>
    </table>
  </div>
</div>

<script src="xlsx.full.min.js"></script>
<script>if(!window.XLSX){var s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/xlsx@0.20.3/dist/xlsx.full.min.js';document.head.appendChild(s);}</script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
console.log('IAM Pricing Tool — build', new Date().toISOString());
(()=>{"use strict";
/* ----------  CATEGORY META  ---------- */
const ORDER=[
 ["bannister rail","cat-orange"],
 ["stainless steel grabrail","cat-orange"],
 ["aluminium grabrail, powder coated","cat-orange"],
 ["shower parts","cat-blue"],
 ["plumbing","cat-blue"],
 ["door components","cat-brown"],
 ["fire safety","cat-red"],
 ["anti slip solutions","cat-yellow"],
 ["uncategorised","cat-yellow"]
];
const META=Object.fromEntries(ORDER.map((o,i)=>[o[0],{idx:i,cls:o[1]}]));
const FALL=META["uncategorised"];
const PRICE_EX=["Rate Ex. GST","Price Ex. GST"];
const TOAST_MS=3000, GST_RATE=0.10, LS_KEY='iam_basket_v2';

/* ----------  STATE & DOM Refs  ---------- */
let wb=null,basket=[],lastRemoved=null,lastAdded=null,uid=0;
const tabs=document.getElementById("sheetTabs"),
      container=document.getElementById("sheetContainer"),
      toast=document.getElementById("toast");

/* ---------- helpers & persistence ---------- */
function escapeHtml(s){
  s = String(s == null ? '' : s);
  return s.replace(/[&<>"']/g, function(m){
    switch(m){
      case '&': return '&amp;';
      case '<': return '&lt;';
      case '>': return '&gt;';
      case '"': return '&quot;';
      default: return '&#39;';
    }
  });
}[m]) || m;
  });
}[m]) || m;
  });
}[m]));}
function saveBasket(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(basket)); }catch(e){} }
function loadBasket(){ try{ const raw=localStorage.getItem(LS_KEY); if(raw){ const arr=JSON.parse(raw); if(Array.isArray(arr)){ basket=arr; uid=Math.max(0,...arr.map(x=>+x.id||0)); renderBasket(); } } }catch(e){} }
loadBasket();

/* ----------  Dark‑mode toggle  ---------- */
document.getElementById("darkModeToggle").onclick=()=>document.body.classList.toggle("dark-mode");

/* ----------  Load Excel & build tabs  ---------- */
const statusEl=document.getElementById('status');
const pickerWrap=document.getElementById('manualLoad');
const picker=document.getElementById('xlsxPicker');

function showStatus(html){ if(statusEl){ statusEl.innerHTML = html; } }
function showPicker(reason){
  showStatus(`<span style="color:#b00">Couldn't load <code>myFile.xlsx</code> (${reason}).</span> You can upload the workbook manually below.`);
  if(pickerWrap) pickerWrap.style.display='block';
}
function whenXLSXReady(cb){
  if(window.XLSX){ cb(); return; }
  // try to load via CDN if missing
  if(!document.querySelector('script[data-sheetjs]')){
    const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/xlsx@0.20.3/dist/xlsx.full.min.js'; s.setAttribute('data-sheetjs','1');
    s.onload=()=>cb(); s.onerror=()=>showPicker('SheetJS failed to load'); document.head.appendChild(s);
  } else {
    let tries=0; const t=setInterval(()=>{ if(window.XLSX){ clearInterval(t); cb(); } else if(++tries>50){ clearInterval(t); showPicker('SheetJS failed to load'); } },100);
  }
}
function parseAndBuild(buf){
  try{ wb = XLSX.read(buf,{type:'array'}); }
  catch(e){ console.error(e); showPicker('invalid file'); return; }
  const sheetNames = Object.keys(wb.Sheets||{});
  if(!sheetNames.length){ showPicker('workbook has no sheets'); return; }
  tabs.innerHTML=''; container.innerHTML=''; showStatus(''); if(pickerWrap) pickerWrap.style.display='none';
  sheetNames.forEach((name,i)=>{
    const b=document.createElement('button'); b.textContent=name; b.dataset.sheet=name;
    b.onclick=()=>{active(name); draw(name);} 
    if(i===0){ b.classList.add('active'); draw(name);} 
    tabs.appendChild(b);
  });
}

window.addEventListener('error', (e)=>{ showStatus(`<span style='color:#b00'>Error:</span> ${e.message}`); });

showStatus('Loading <code>myFile.xlsx</code>…');
fetch('./myFile.xlsx', {cache:'no-store'})
  .then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.arrayBuffer(); })
  .then(buf=>{ whenXLSXReady(()=>parseAndBuild(buf)); })
  .catch(err=>{ console.error(err); showPicker(err.message || 'network error'); });

if(if(picker){
  picker.addEventListener('change', function(e){
    var tgt = e && e.target; var files = tgt && tgt.files; var f = files && files[0];
    if(!f) return;
    if(f.arrayBuffer){
      f.arrayBuffer().then(function(ab){ whenXLSXReady(function(){ parseAndBuild(ab); }); });
    } else {
      var reader = new FileReader();
      reader.onload = function(ev){ var ab = ev.target.result; whenXLSXReady(function(){ parseAndBuild(ab); }); };
      reader.readAsArrayBuffer(f);
    }
  });
}

/* ----------  Toast ---------- */
function showToast(msg,undo){
  toast.textContent=msg;toast.classList.add("show");
  if(undo){toast.style.cursor="pointer";toast.onclick=()=>{undo();toast.classList.remove("show");}}
  else{toast.style.cursor="default";toast.onclick=null}
  setTimeout(()=>toast.classList.remove("show"),TOAST_MS);
}

/* ----------  Basket ---------- */
const bBody=document.querySelector("#basketTable tbody"), bFoot=document.querySelector("#basketTable tfoot");
document.getElementById("toggleBasketBtn").onclick=e=>{
  const bc=document.getElementById("basketContent");
  bc.style.display=bc.style.display==="none"?"block":"none";
  e.target.textContent=bc.style.display==="none"?"Show Basket":"Hide Basket";
};
// header controls
const addCustomBtn=document.getElementById('addCustomBtn');
const clearBasketBtn=document.getElementById('clearBasketBtn');
if(addCustomBtn){addCustomBtn.onclick=()=>{const nl={id:++uid,item:'Custom item',code:'',unit:'',notes:'',hours:0,qty:1,ex:0,gst:true,lineNote:'',open:true};basket.push(nl);renderBasket();};}
if(clearBasketBtn){clearBasketBtn.onclick=()=>{if(!basket.length)return;basket=[];renderBasket();showToast('Basket cleared');};}
  bc.style.display=bc.style.display==="none"?"block":"none";
  e.target.textContent=bc.style.display==="none"?"Show Basket":"Hide Basket";
};

function addItem(row,header){
  const catIdx=header.indexOf("Category");
  const itemCol=header.findIndex(h=>String(h).toLowerCase()==="item");
  const hL=header.map(h=>String(h).toLowerCase());
  const codeIdx=hL.indexOf('code');
  const unitIdx=hL.indexOf('unit');
  const notesIdx=hL.indexOf('notes');
  const hoursIdx=hL.findIndex(h=>h.includes('estimated') && h.includes('time'));
  const firstNonEmpty=row.find((v,i)=>i!==catIdx && String(v).trim()!=='');
  let desc=itemCol!==-1?row[itemCol]:firstNonEmpty||"Unnamed Item";
  const exIdx=header.findIndex(h=>PRICE_EX.includes(h));
  const ex = exIdx===-1 ? NaN : +row[exIdx];
  const newLine={
    id:++uid,
    item:desc,
    code: codeIdx>-1? row[codeIdx]:"",
    unit: unitIdx>-1? row[unitIdx]:"",
    notes: notesIdx>-1? row[notesIdx]:"",
    hours: hoursIdx>-1? (parseFloat(row[hoursIdx])||0):0,
    qty:1, ex, gst:true, lineNote:'', open:false
  };
  basket.push(newLine);
  lastAdded=newLine;renderBasket();
}
function undoAdd(){if(lastAdded){const i=basket.findIndex(x=>x.id===lastAdded.id);if(i>-1)basket.splice(i,1);lastAdded=null;renderBasket();}}
function undoRemove(){if(lastRemoved){basket.splice(lastRemoved.i,0,lastRemoved.b);lastRemoved=null;renderBasket();}}

function renderBasket(){
  var cont=document.getElementById('basketContainer'); cont.style.display=basket.length?'block':'none';
  if(!basket.length){ bBody.innerHTML=''; bFoot.innerHTML=''; saveBasket(); return; }
  bBody.innerHTML=''; var totEx=0, totGst=0;
  basket.forEach(function(b,i){
    var tr=document.createElement('tr'); tr.className='main-row'; tr.dataset.id=String(b.id||'');
    // handle + expander
    var tdHandle=document.createElement('td'); tdHandle.className='sort-handle';
    var exp=document.createElement('button'); exp.className='expander'; exp.textContent=b.open?'▾':'▸';
    exp.onclick=function(){ b.open=!b.open; renderBasket(); };
    var bars=document.createElement('span'); bars.textContent=' ≡';
    tdHandle.appendChild(exp); tdHandle.appendChild(bars); tr.appendChild(tdHandle);
    // item editable
    var tdItem=document.createElement('td');
    var itemInput=document.createElement('input'); itemInput.type='text'; itemInput.value=b.item; itemInput.className='editable item-input';
    itemInput.onchange=function(){ b.item=itemInput.value; saveBasket(); };
    tdItem.appendChild(itemInput); tr.appendChild(tdItem);
    // qty
    var tdQ=document.createElement('td'); var qc=document.createElement('div'); qc.className='qty-controls';
    var minus=document.createElement('button'); minus.textContent='-';
    var inp=document.createElement('input'); inp.type='number'; inp.step='0.1'; inp.className='qty-input'; inp.value=b.qty;
    var plus=document.createElement('button'); plus.textContent='+';
    minus.onclick=function(){ b.qty=Math.max(1,b.qty-1); renderBasket(); };
    plus.onclick=function(){ b.qty+=1; renderBasket(); };
    inp.onchange=function(){ b.qty=Math.max(1,parseFloat(inp.value)||1); renderBasket(); };
    qc.appendChild(minus); qc.appendChild(inp); qc.appendChild(plus); tdQ.appendChild(qc); tr.appendChild(tdQ);
    // price ex editable
    var tdEx=document.createElement('td');
    var exInput=document.createElement('input'); exInput.type='number'; exInput.step='0.01'; exInput.className='editable price-input';
    exInput.value=isNaN(b.ex)?'':Number(b.ex).toFixed(2);
    exInput.onchange=function(){ var v=parseFloat(exInput.value); b.ex=isFinite(v)?v:NaN; renderBasket(); };
    tdEx.appendChild(exInput); tr.appendChild(tdEx);
    // GST apply checkbox
    var tdGstApply=document.createElement('td'); tdGstApply.className='gst-cell';
    var gstInput=document.createElement('input'); gstInput.type='checkbox'; gstInput.className='gst-input'; gstInput.checked=!!b.gst;
    gstInput.onchange=function(){ b.gst=gstInput.checked; renderBasket(); };
    tdGstApply.appendChild(gstInput); tr.appendChild(tdGstApply);
    // line totals
    var le=isNaN(b.ex)?0:b.qty*b.ex; // ex-GST line total
    var gstAmt=b.gst?le*GST_RATE:0; var li=le+gstAmt; totEx+=le; totGst+=gstAmt;
    var tdLe=document.createElement('td'); tdLe.textContent=isNaN(b.ex)?'N/A':le.toFixed(2);
    var tdG=document.createElement('td'); tdG.textContent=isNaN(b.ex)?'N/A':gstAmt.toFixed(2);
    var tdLi=document.createElement('td'); tdLi.textContent=isNaN(b.ex)?'N/A':li.toFixed(2);
    tr.appendChild(tdLe); tr.appendChild(tdG); tr.appendChild(tdLi);
    // remove
    var tdRem=document.createElement('td'); var x=document.createElement('span'); x.className='remove-btn'; x.textContent='X';
    x.onclick=function(){ lastRemoved={b:b,i:i}; tr.classList.add('fade-out'); setTimeout(function(){ basket.splice(i,1); renderBasket(); showToast('Item removed ↩', undoRemove); },300); };
    tdRem.appendChild(x); tr.appendChild(tdRem);
    bBody.appendChild(tr);
    // details row (DOM-built, no template strings)
    var dtr=document.createElement('tr'); dtr.className='details-row'; dtr.style.display=b.open?'table-row':'none';
    var dtd=document.createElement('td'); dtd.colSpan=9;
    var panel=document.createElement('div'); panel.className='details-panel';
    var grid=document.createElement('div'); grid.className='details-grid'; panel.appendChild(grid);
    function addRO(labelText, valueText){
      var wrap=document.createElement('div'); var lab=document.createElement('label'); lab.textContent=labelText; wrap.appendChild(lab);
      var box=document.createElement('div'); box.className='ro'; box.textContent=valueText||''; wrap.appendChild(box); return wrap;
    }
    grid.appendChild(addRO('Code', b.code));
    grid.appendChild(addRO('Unit', b.unit));
    var hoursWrap=document.createElement('div'); var hLab=document.createElement('label'); hLab.textContent='Hours'; hoursWrap.appendChild(hLab);
    var hInput=document.createElement('input'); hInput.type='number'; hInput.step='0.1'; hInput.className='hours-input'; hInput.value=(b.hours!=null?b.hours:''); hoursWrap.appendChild(hInput); grid.appendChild(hoursWrap);
    grid.appendChild(addRO('Notes (from sheet)', b.notes));
    var lnWrap=document.createElement('div'); lnWrap.className='line-note'; var lnLab=document.createElement('label'); lnLab.textContent='Line note (editable)'; lnWrap.appendChild(lnLab);
    var lnTA=document.createElement('textarea'); lnTA.rows=2; lnTA.className='line-note-input'; lnTA.value=b.lineNote||''; lnWrap.appendChild(lnTA); grid.appendChild(lnWrap);
    var act=document.createElement('div'); act.className='actions'; var dup=document.createElement('button'); dup.className='dup-btn'; dup.textContent='Duplicate line'; act.appendChild(dup); grid.appendChild(act);
    dtd.appendChild(panel); dtr.appendChild(dtd); bBody.appendChild(dtr);
    // bind detail inputs
    hInput.onchange=function(){ var v=parseFloat(hInput.value); b.hours=isNaN(v)?0:v; saveBasket(); };
    lnTA.onchange=function(){ b.lineNote=lnTA.value; saveBasket(); };
    dup.onclick=function(){ var clone=JSON.parse(JSON.stringify(b)); clone.id=++uid; clone.open=false; basket.splice(i+1,0,clone); renderBasket(); showToast('Line duplicated'); };
  });
  var grand=totEx+totGst;
  bFoot.innerHTML='<tr>'+
    '<td colspan="5" style="text-align:right;font-weight:bold">Grand Totals:</td>'+
    '<td style="font-weight:bold">'+totEx.toFixed(2)+'</td>'+
    '<td style="font-weight:bold">'+totGst.toFixed(2)+'</td>'+
    '<td style="font-weight:bold">'+grand.toFixed(2)+'</td>'+
    '<td></td>'+
  '</tr>';
  if(window.Sortable){
    Sortable.create(bBody,{handle: '.sort-handle', draggable: 'tr.main-row', animation: 150, onEnd: function(){
      var rows=bBody.querySelectorAll('tr.main-row'); var order=[]; for(var k=0;k<rows.length;k++){ order.push(rows[k].dataset.id); }
      basket = order.map(function(id){ for(var j=0;j<basket.length;j++){ if(String(basket[j].id)===id) return basket[j]; } });
      saveBasket();
    }});
  }
  saveBasket();
}

/* ----------  CSV ---------- */
document.getElementById("exportCsvBtn").onclick=()=>{
  if(!basket.length)return;
  const esc=v=>`"${String(v).replace(/"/g,'""')}"`;
  const lines=[["Item","Quantity","Price Ex. GST","GST Apply","Line Ex","GST","Line Total"].map(esc)];
  let totEx=0,totGst=0;
  basket.forEach(b=>{
    const le=isNaN(b.ex)?0:b.qty*b.ex; totEx+=le;
    const gstAmt=b.gst?le*GST_RATE:0; totGst+=gstAmt;
    const li=le+gstAmt;
    lines.push([b.item,b.qty,isNaN(b.ex)?"N/A":Number(b.ex).toFixed(2), b.gst?"Yes":"No",
      isNaN(b.ex)?"N/A":le.toFixed(2), isNaN(b.ex)?"N/A":gstAmt.toFixed(2), isNaN(b.ex)?"N/A":li.toFixed(2)].map(esc));
  });
  const grand=(totEx+totGst).toFixed(2);
  lines.push(['','','','Totals:',totEx.toFixed(2),totGst.toFixed(2),grand].map(esc));
  const csv = lines.map(r=>r.join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="quote_basket.csv";
  document.body.appendChild(a);a.click();document.body.removeChild(a);
};
})();
console.log('IAM Pricing Tool — script loaded OK');
window.__iam_main_ok__=true;
</script>
<script>
(function(){
  try{
    if(!window.__iam_main_ok__){
      var status=document.getElementById('status');
      if(status){status.innerHTML='<span style="color:#b00">Main script didn\'t finish loading. Check Console for the first red error above.</span>';}
      // Minimal fallback: try to render first sheet so the page is not blank
      if(window.XLSX){
        fetch('./myFile.xlsx', {cache:'no-store'}).then(function(r){return r.arrayBuffer();}).then(function(buf){
          var wb=XLSX.read(buf,{type:'array'});
          var names=Object.keys(wb.Sheets||{}); if(!names.length) return;
          var html=XLSX.utils.sheet_to_html(wb.Sheets[names[0]]);
          document.getElementById('sheetContainer').innerHTML=html;
        }).catch(function(){});
      }
    }
  }catch(e){/* ignore */}
})();
</script>
</body>
</html>
