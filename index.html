<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>In A Minnit Pricing Tool 1.0</title>
  <style>
    /* Global Page Styles */
    body {
      font-family: sans-serif;
      margin: 1rem;
      background-color: #f7f7f7;
    }
    h1 {
      margin-bottom: 0.2rem;
    }
    p {
      margin-top: 0;
      margin-bottom: 2rem;
    }

    /* Sheet Buttons */
    #sheetButtons > button {
      margin-right: 0.5rem;
      background-color: #007bff;
      color: #fff;
      border: none;
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      cursor: pointer;
    }
    #sheetButtons > button:hover {
      background-color: #0056b3;
    }

    /* Main Sheet Table (inside #sheetContainer) */
    #sheetContainer table {
      border-collapse: collapse;
      width: 100%;
    }
    /* Header row for main sheet table only */
    #sheetContainer table tr:first-child td {
      text-align: center;
      background-color: #e0e0e0;
      font-weight: bold;
    }
    /* Data rows (non-header) left-aligned */
    #sheetContainer table tr:not(:first-child) td {
      text-align: left;
    }
    #sheetContainer table td, 
    #sheetContainer table th {
      border: 1px solid #aaa;
      padding: 0.5rem;
    }
    /* Pronounced hover effect for main sheet rows */
    #sheetContainer table tbody tr:hover {
      background-color: #dddddd;
    }

    /* Visual feedback for copy-to-clipboard */
    .copied-cell {
      background-color: #c8e6c9 !important;
      transition: background-color 0.3s ease;
    }

    /* Search Container with extra spacing */
    .search-container {
      margin-bottom: 1rem;
      padding: 0.5rem;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .search-label {
      font-weight: bold;
      margin-right: 0.5rem;
    }
    .search-input {
      padding: 0.4rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 200px;
    }

    /* Basket Container (original styling) */
    #basketContainer {
      display: none;
      padding: 1rem;
      margin-top: 2rem;
      border: 1px solid #aaa;
    }
    #basketContainer h3 {
      margin-top: 0;
    }
    #basketTable {
      width: 100%;
      border-collapse: collapse;
    }
    #basketTable th,
    #basketTable td {
      border: 1px solid #aaa;
      padding: 0.5rem;
      text-align: left;
    }

    /* Quantity Controls in Basket */
    .qty-controls {
      display: flex;
      align-items: center;
    }
    .qty-controls button {
      margin: 0 5px;
    }
    .qty-input {
      width: 60px;
      text-align: center;
    }

    /* Remove Button in Basket */
    .remove-btn {
      color: red;
      font-weight: bold;
      cursor: pointer;
    }

    /* Green "Add to Basket" Button for Main Table */
    .add-button {
      background-color: #28a745;
      border: none;
      color: #fff;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    .add-button:hover {
      background-color: #218838;
    }
  </style>
</head>
<body>
  <h1>In A Minnit Pricing Tool 1.0</h1>
  <p><em>Beta version â€“ features subject to change. Always check your work. Report bugs to Marco.</em></p>
  
  <!-- Sheet Navigation and Display -->
  <div id="sheetButtons"></div>
  <div id="sheetContainer"></div>
  
  <!-- Basket Section -->
  <div id="basketContainer">
    <h3>Quote Basket</h3>
    <div class="basket-actions">
      <button id="exportCsvBtn">Export quote CSV</button>
    </div>
    <table id="basketTable">
      <thead>
        <tr>
          <th>Item</th>
          <th>Quantity</th>
          <th>Price Ex. GST</th>
          <th>Price Inc. GST</th>
          <th>Line Total Ex. GST</th>
          <th>Line Total Inc. GST</th>
          <th>Remove</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p><strong>Grand Total (Ex. GST):</strong> $<span id="grandEx">0.00</span></p>
    <p><strong>Grand Total (Inc. GST):</strong> $<span id="grandInc">0.00</span></p>
  </div>
  
  <!-- Include SheetJS Library -->
  <script src="xlsx.full.min.js"></script>
  <script>
    (function() {
      "use strict";
      
      /* ---------------- CONFIGURATION ---------------- */
      const PRICE_COLUMNS_EX = ["Rate Ex. GST", "Price Ex. GST"];
      const PRICE_COLUMN_INC = "Price Inc. GST";
      
      /* ---------------- GLOBAL VARIABLES ---------------- */
      let basket = [];
      
      /* ---------------- DOM ELEMENTS ---------------- */
      const sheetButtons = document.getElementById("sheetButtons");
      const sheetContainer = document.getElementById("sheetContainer");
      const basketContainer = document.getElementById("basketContainer");
      const basketTableBody = document.querySelector("#basketTable tbody");
      const grandExEl = document.getElementById("grandEx");
      const grandIncEl = document.getElementById("grandInc");
      const exportCsvBtn = document.getElementById("exportCsvBtn");
      
      /* ---------------- FETCH & PARSE EXCEL ---------------- */
      fetch("myFile.xlsx")
        .then(response => response.arrayBuffer())
        .then(data => {
          const workbook = XLSX.read(data, { type: "array" });
          Object.keys(workbook.Sheets).forEach(sheetName => {
            const btn = document.createElement("button");
            btn.textContent = sheetName;
            btn.onclick = () => showSheet(workbook, sheetName);
            sheetButtons.appendChild(btn);
          });
        })
        .catch(err => {
          console.error("Failed to fetch Excel file:", err);
          sheetContainer.textContent = "Error fetching Excel file.";
        });
      
      /* ---------------- SHOW SHEET & BUILD MAIN TABLE ---------------- */
      function showSheet(workbook, sheetName) {
        const sheet = workbook.Sheets[sheetName];
        let rows = XLSX.utils.sheet_to_json(sheet, {
          header: 1,
          defval: "",
          blankrows: true
        });
        // Ensure each row has the same number of columns
        const maxCols = Math.max(...rows.map(r => r.length));
        rows.forEach(row => {
          while (row.length < maxCols) row.push("");
        });
        sheetContainer.innerHTML = "";
        const wrapper = document.createElement("div");
        wrapper.classList.add("sheet-view");
        sheetContainer.appendChild(wrapper);
        
        // Search Container with extra spacing
        const searchDiv = document.createElement("div");
        searchDiv.classList.add("search-container");
        const searchLabel = document.createElement("label");
        searchLabel.classList.add("search-label");
        searchLabel.textContent = "Search items:";
        const searchInput = document.createElement("input");
        searchInput.type = "text";
        searchInput.placeholder = "Type to filter...";
        searchInput.classList.add("search-input");
        searchDiv.appendChild(searchLabel);
        searchDiv.appendChild(searchInput);
        wrapper.appendChild(searchDiv);
        
        // Table Container
        const tableContainer = document.createElement("div");
        wrapper.appendChild(tableContainer);
        
        // Get header row from first row of data
        const headers = rows.length > 0 ? rows[0].map(h => String(h).trim()) : [];
      
        function buildTable(filteredRows) {
          tableContainer.innerHTML = "";
          const table = document.createElement("table");
          const tbody = document.createElement("tbody");
          
          filteredRows.forEach((row, rowIndex) => {
            const tr = document.createElement("tr");
            // For data rows, add a green "Add to Basket" button at the far left.
            if (rowIndex > 0) {
              const addCell = document.createElement("td");
              const addBtn = document.createElement("button");
              addBtn.classList.add("add-button");
              addBtn.textContent = "+";
              addBtn.onclick = () => addToBasket(row, headers);
              addCell.appendChild(addBtn);
              tr.appendChild(addCell);
            } else {
              // For header row, add an empty cell for alignment.
              const emptyCell = document.createElement("td");
              emptyCell.textContent = "";
              tr.appendChild(emptyCell);
            }
            
            // Add the rest of the cells
            row.forEach((cellValue, colIndex) => {
              const td = document.createElement("td");
              // For price columns (data rows), make the text bold
              if (rowIndex > 0 && headers[colIndex] &&
                  (headers[colIndex].toLowerCase().includes("ex. gst") ||
                   headers[colIndex].toLowerCase().includes("inc. gst"))) {
                td.style.fontWeight = "bold";
              }
              td.textContent = formatIfPrice(rowIndex, headers[colIndex], cellValue);
              // Implement click-to-copy with visual feedback
              td.onclick = (e) => {
                // Avoid conflict with the add button cell
                if (e.target.tagName.toLowerCase() === "button") return;
                copyCellText(td);
              };
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
          table.appendChild(tbody);
          tableContainer.appendChild(table);
        }
        
        buildTable(rows);
        
        // Filter rows as user types
        searchInput.addEventListener("input", () => {
          const filterVal = searchInput.value.trim().toLowerCase();
          if (!filterVal) {
            buildTable(rows);
            return;
          }
          const filtered = rows.filter((r, i) => {
            if (i === 0) return true;
            return r.some(cell => String(cell).toLowerCase().includes(filterVal));
          });
          buildTable(filtered);
        });
      }
      
      function formatIfPrice(rowIndex, colHeader, cellValue) {
        if (rowIndex === 0) return cellValue;
        const lower = (colHeader || "").toLowerCase();
        if (lower.includes("ex. gst") || lower.includes("inc. gst")) {
          const parsed = parseFloat(cellValue);
          if (!isNaN(parsed)) return parsed.toFixed(2);
        }
        return cellValue;
      }
      
      /* ---------------- CLICK-TO-COPY FUNCTION ---------------- */
      function copyCellText(td) {
        const text = td.textContent;
        navigator.clipboard.writeText(text)
          .then(() => {
            td.classList.add("copied-cell");
            setTimeout(() => td.classList.remove("copied-cell"), 300);
            console.log("Copied:", text);
          })
          .catch(err => console.error("Clipboard error:", err));
      }
      
      /* ---------------- BASKET FUNCTIONS ---------------- */
      function addToBasket(row, headers) {
        const itemName = row[0] || "Untitled";
        let exPrice = null;
        let incPrice = null;
        for (let i = 0; i < headers.length; i++) {
          const head = headers[i];
          const val = parseFloat(row[i]);
          if (PRICE_COLUMNS_EX.includes(head) && !isNaN(val)) {
            exPrice = val;
          }
          if (head === PRICE_COLUMN_INC && !isNaN(val)) {
            incPrice = val;
          }
        }
        const existing = basket.find(it => it.itemName === itemName);
        if (existing) {
          existing.quantity = parseFloat(existing.quantity) + 1;
        } else {
          basket.push({
            itemName,
            quantity: 1,
            exPrice,
            incPrice
          });
        }
        renderBasket();
      }
      
      function renderBasket() {
        if (basket.length === 0) {
          basketContainer.style.display = "none";
          return;
        }
        basketContainer.style.display = "block";
        basketTableBody.innerHTML = "";
        let totalEx = 0;
        let totalInc = 0;
        basket.forEach((item, index) => {
          const tr = document.createElement("tr");
          
          // Item Name
          const nameTd = document.createElement("td");
          nameTd.textContent = item.itemName;
          tr.appendChild(nameTd);
          
          // Quantity controls (with +/- buttons and numeric input)
          const qtyTd = document.createElement("td");
          const qtyControls = document.createElement("div");
          qtyControls.classList.add("qty-controls");
          
          const minusBtn = document.createElement("button");
          minusBtn.textContent = "-";
          minusBtn.onclick = () => {
            let q = parseFloat(item.quantity) || 1;
            q = q - 1;
            if (q < 1) q = 1;
            item.quantity = q;
            renderBasket();
          };
          
          const qtyInput = document.createElement("input");
          qtyInput.type = "number";
          qtyInput.step = "0.1";
          qtyInput.classList.add("qty-input");
          qtyInput.value = item.quantity;
          qtyInput.onchange = () => {
            let val = parseFloat(qtyInput.value);
            if (isNaN(val) || val < 1) val = 1;
            item.quantity = val;
            renderBasket();
          };
          
          const plusBtn = document.createElement("button");
          plusBtn.textContent = "+";
          plusBtn.onclick = () => {
            let q = parseFloat(item.quantity) || 1;
            q = q + 1;
            item.quantity = q;
            renderBasket();
          };
          
          qtyControls.appendChild(minusBtn);
          qtyControls.appendChild(qtyInput);
          qtyControls.appendChild(plusBtn);
          qtyTd.appendChild(qtyControls);
          tr.appendChild(qtyTd);
          
          // Price Ex. GST (bold)
          const priceExTd = document.createElement("td");
          priceExTd.textContent = item.exPrice !== null ? item.exPrice.toFixed(2) : "N/A";
          priceExTd.style.fontWeight = "bold";
          tr.appendChild(priceExTd);
          
          // Price Inc. GST (bold)
          const priceIncTd = document.createElement("td");
          priceIncTd.textContent = item.incPrice !== null ? item.incPrice.toFixed(2) : "N/A";
          priceIncTd.style.fontWeight = "bold";
          tr.appendChild(priceIncTd);
          
          // Line Total Ex. GST
          const qVal = parseFloat(item.quantity) || 1;
          const lineExTd = document.createElement("td");
          if (item.exPrice !== null) {
            const lineEx = qVal * item.exPrice;
            lineExTd.textContent = lineEx.toFixed(2);
            totalEx += lineEx;
          } else {
            lineExTd.textContent = "N/A";
          }
          tr.appendChild(lineExTd);
          
          // Line Total Inc. GST
          const lineIncTd = document.createElement("td");
          if (item.incPrice !== null) {
            const lineInc = qVal * item.incPrice;
            lineIncTd.textContent = lineInc.toFixed(2);
            totalInc += lineInc;
          } else {
            lineIncTd.textContent = "N/A";
          }
          tr.appendChild(lineIncTd);
          
          // Remove Button
          const removeTd = document.createElement("td");
          const removeBtn = document.createElement("span");
          removeBtn.textContent = "X";
          removeBtn.classList.add("remove-btn");
          removeBtn.onclick = () => {
            basket.splice(index, 1);
            renderBasket();
          };
          removeTd.appendChild(removeBtn);
          tr.appendChild(removeTd);
          
          basketTableBody.appendChild(tr);
        });
        grandExEl.textContent = totalEx.toFixed(2);
        grandIncEl.textContent = totalInc.toFixed(2);
      }
      
      /* ---------------- EXPORT CSV FUNCTION ---------------- */
      exportCsvBtn.onclick = () => {
        if (basket.length === 0) return;
        const lines = [];
        lines.push(["Item", "Quantity", "Price Ex. GST", "Price Inc. GST", "Line Ex", "Line Inc"]);
        let totalEx = 0;
        let totalInc = 0;
        basket.forEach(item => {
          const q = parseFloat(item.quantity) || 1;
          const lineEx = (item.exPrice !== null) ? q * item.exPrice : 0;
          const lineInc = (item.incPrice !== null) ? q * item.incPrice : 0;
          totalEx += lineEx;
          totalInc += lineInc;
          lines.push([
            item.itemName,
            String(q),
            item.exPrice !== null ? item.exPrice.toFixed(2) : "N/A",
            item.incPrice !== null ? item.incPrice.toFixed(2) : "N/A",
            item.exPrice !== null ? lineEx.toFixed(2) : "N/A",
            item.incPrice !== null ? lineInc.toFixed(2) : "N/A"
          ]);
        });
        lines.push(["", "", "", "Totals:", totalEx.toFixed(2), totalInc.toFixed(2)]);
        const csvContent = lines.map(line => line.join(",")).join("\n");
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "quote_basket.csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };
      
    })();
  </script>
</body>
</html>