<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>InAMinnit Pricing Sheet with Basket</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 1rem;
    }
    #sheetButtons > button {
      margin-right: 0.5rem;
    }
    /* Container for search box + table */
    .sheet-view {
      margin-bottom: 2rem;
    }
    table {
      border-collapse: collapse;
      margin-top: 0.5rem;
      width: 100%;
      max-width: 100%;
    }
    td, th {
      border: 1px solid #aaa;
      padding: 0.5rem;
      cursor: default;
    }
    td:active {
      background-color: #f2f2f2; /* Quick visual feedback on click */
    }
    .header-cell {
      background-color: #d3d3d3; /* Light grey background for header */
      font-weight: bold;
    }
    .search-label {
      margin-right: 0.5rem;
    }
    /* Basket UI */
    #basketContainer {
      margin-top: 2rem;
      padding: 1rem;
      border: 2px solid #ccc;
    }
    #basketContainer h3 {
      margin-top: 0;
    }
    .basket-actions button {
      margin-right: 0.5rem;
    }
    .remove-btn {
      color: red;
      cursor: pointer;
    }
    /* Buttons in the quantity cell */
    .qty-controls button {
      margin: 0 5px;
    }
  </style>
</head>
<body>

<h2>InAMinnit Pricing Sheet</h2>
<p>Early Alpha version - only for test purposes</p>

<div id="sheetButtons"></div>
<div id="sheetContainer"></div>

<!-- Basket Section -->
<div id="basketContainer" style="display: none;">
  <h3>Quote Basket</h3>
  <div class="basket-actions">
    <button id="exportCsvBtn">Export CSV</button>
    <button id="exportPdfBtn">Export PDF</button>
  </div>
  <table id="basketTable">
    <thead>
      <tr>
        <th>Item</th>
        <th>Quantity</th>
        <th>Unit Price</th>
        <th>Line Total</th>
        <th>Remove</th>
      </tr>
    </thead>
    <tbody>
      <!-- Basket items go here -->
    </tbody>
  </table>
  <p><strong>Grand Total:</strong> $<span id="basketGrandTotal">0.00</span></p>
</div>

<!-- SheetJS library -->
<script src="xlsx.full.min.js"></script>
<!-- jsPDF from CDN (for PDF generation) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
        integrity="sha512-8W9fMc2X8tHEM37fuf//sAlRrVvpU7L8dT8uvY1PoBn+Qm1N+WWNA09O6rOZZ3QtrKXIjhKTkOquFGlH+zcc1A=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
/* ------------------------------------------------------------------
  CONFIG
------------------------------------------------------------------ */
const PRICE_COLUMNS = [
  "Rate Ex. GST",
  "Price Ex. GST",
  "Price Inc. GST"
];

/* ------------------------------------------------------------------
  GLOBALS
------------------------------------------------------------------ */
let basket = []; // Array of objects: { itemName, unitPrice, quantity }

/* DOM Elements */
const sheetButtons = document.getElementById("sheetButtons");
const sheetContainer = document.getElementById("sheetContainer");
const basketContainer = document.getElementById("basketContainer");
const basketTableBody = document.querySelector("#basketTable tbody");
const basketGrandTotalEl = document.getElementById("basketGrandTotal");
const exportCsvBtn = document.getElementById("exportCsvBtn");
const exportPdfBtn = document.getElementById("exportPdfBtn");

/* ------------------------------------------------------------------
  FETCH & PARSE EXCEL
------------------------------------------------------------------ */
fetch("myFile.xlsx")
  .then(response => response.arrayBuffer())
  .then(data => {
    const workbook = XLSX.read(data, { type: "array" });
    // Make a button for each sheet
    Object.keys(workbook.Sheets).forEach(sheetName => {
      const btn = document.createElement("button");
      btn.textContent = sheetName;
      btn.onclick = () => showSheet(workbook, sheetName);
      sheetButtons.appendChild(btn);
    });
  })
  .catch(err => {
    console.error("Failed to fetch Excel file:", err);
    sheetContainer.textContent = "Error fetching Excel file.";
  });

/* ------------------------------------------------------------------
  SHOW SELECTED SHEET WITH SEARCH & "ADD TO BASKET"
------------------------------------------------------------------ */
function showSheet(workbook, sheetName) {
  const sheet = workbook.Sheets[sheetName];

  // Convert sheet to 2D array
  const rows = XLSX.utils.sheet_to_json(sheet, {
    header: 1,
    defval: "",
    blankrows: true
  });

  // Equalize column lengths
  const maxCols = Math.max(...rows.map(r => r.length));
  rows.forEach(row => {
    while (row.length < maxCols) row.push("");
  });

  // Clear container
  sheetContainer.innerHTML = "";
  const wrapper = document.createElement("div");
  wrapper.classList.add("sheet-view");
  sheetContainer.appendChild(wrapper);

  // Build search input
  const searchLabel = document.createElement("label");
  searchLabel.textContent = "Search items:";
  searchLabel.classList.add("search-label");

  const searchInput = document.createElement("input");
  searchInput.type = "text";
  searchInput.placeholder = "Type to filter...";

  wrapper.appendChild(searchLabel);
  wrapper.appendChild(searchInput);

  // Container for the table
  const tableContainer = document.createElement("div");
  wrapper.appendChild(tableContainer);

  // If there's at least one row, treat the first row as headers
  let headers = rows.length > 0 ? rows[0].map(h => String(h).trim()) : [];

  function buildTable(filteredRows) {
    tableContainer.innerHTML = "";
    const table = document.createElement("table");

    filteredRows.forEach((row, rowIndex) => {
      const tr = document.createElement("tr");
      
      row.forEach((cellValue, colIndex) => {
        const td = document.createElement("td");

        // Header row styling
        if (rowIndex === 0) {
          td.classList.add("header-cell");
        }

        let displayText = cellValue;
        // Round if it's a price column (and not the header row)
        if (rowIndex > 0 && headers[colIndex]) {
          const colHeader = headers[colIndex];
          if (PRICE_COLUMNS.includes(colHeader)) {
            const parsedNum = parseFloat(cellValue);
            if (!isNaN(parsedNum)) {
              displayText = parsedNum.toFixed(2);
            }
          }
        }

        td.textContent = displayText;

        // Click to copy any cell
        td.onclick = () => {
          navigator.clipboard.writeText(displayText)
            .then(() => console.log("Copied:", displayText))
            .catch(err => console.error("Clipboard error:", err));
        };

        tr.appendChild(td);
      });

      // Add an "Add to basket" button if not the header row
      if (rowIndex > 0) {
        const addCell = document.createElement("td");
        const addBtn = document.createElement("button");
        addBtn.textContent = "Add to basket";
        addBtn.onclick = () => addToBasket(row, headers);
        addCell.appendChild(addBtn);
        tr.appendChild(addCell);
      }

      table.appendChild(tr);
    });

    tableContainer.appendChild(table);
  }

  // Build initial table with all rows
  buildTable(rows);

  // Filter as user types
  searchInput.addEventListener("input", () => {
    const filterVal = searchInput.value.trim().toLowerCase();
    if (!filterVal) {
      // Show all
      buildTable(rows);
      return;
    }
    // Keep header row + any row that matches
    const filtered = rows.filter((r, i) => {
      if (i === 0) return true; // always keep header
      return r.some(cell => String(cell).toLowerCase().includes(filterVal));
    });
    buildTable(filtered);
  });
}

/* ------------------------------------------------------------------
  BASKET LOGIC
------------------------------------------------------------------ */
function addToBasket(row, headers) {
  // "row" is an array of cell values
  // You might want the item name from column 0 (or whichever column).
  const itemName = row[0];
  
  // Find the price from known PRICE_COLUMNS
  let unitPrice = 0;
  for (let i = 0; i < headers.length; i++) {
    if (PRICE_COLUMNS.includes(headers[i])) {
      const parsed = parseFloat(row[i]);
      if (!isNaN(parsed)) {
        unitPrice = parsed;
        break; 
      }
    }
  }

  // Check if item is already in the basket
  const existing = basket.find(item => item.itemName === itemName);
  if (existing) {
    existing.quantity += 1; // increment by 1
  } else {
    // Add new item with quantity=1
    basket.push({
      itemName,
      unitPrice,
      quantity: 1
    });
  }

  renderBasket();
}

function renderBasket() {
  // If basket empty, hide container
  if (basket.length === 0) {
    basketContainer.style.display = "none";
    return;
  } else {
    basketContainer.style.display = "block";
  }

  // Clear existing rows
  basketTableBody.innerHTML = "";

  let grandTotal = 0;

  basket.forEach((item, index) => {
    const tr = document.createElement("tr");

    // Item name
    const nameTd = document.createElement("td");
    nameTd.textContent = item.itemName;
    tr.appendChild(nameTd);

    // Quantity with +/- buttons
    const qtyTd = document.createElement("td");
    const qtyControls = document.createElement("div");
    qtyControls.classList.add("qty-controls");

    // Minus button
    const minusBtn = document.createElement("button");
    minusBtn.textContent = "-";
    minusBtn.onclick = () => {
      item.quantity = Math.max(1, item.quantity - 1);
      renderBasket();
    };

    // Displayed quantity
    const qtySpan = document.createElement("span");
    qtySpan.textContent = item.quantity;
    qtySpan.style.margin = "0 8px";

    // Plus button
    const plusBtn = document.createElement("button");
    plusBtn.textContent = "+";
    plusBtn.onclick = () => {
      item.quantity++;
      renderBasket();
    };

    qtyControls.appendChild(minusBtn);
    qtyControls.appendChild(qtySpan);
    qtyControls.appendChild(plusBtn);
    qtyTd.appendChild(qtyControls);
    tr.appendChild(qtyTd);

    // Unit price
    const priceTd = document.createElement("td");
    priceTd.textContent = item.unitPrice.toFixed(2);
    tr.appendChild(priceTd);

    // Line total
    const lineTotal = item.quantity * item.unitPrice;
    const totalTd = document.createElement("td");
    totalTd.textContent = lineTotal.toFixed(2);
    tr.appendChild(totalTd);

    // Remove item
    const removeTd = document.createElement("td");
    const removeBtn = document.createElement("span");
    removeBtn.textContent = "X";
    removeBtn.classList.add("remove-btn");
    removeBtn.onclick = () => {
      basket.splice(index, 1);
      renderBasket();
    };
    removeTd.appendChild(removeBtn);
    tr.appendChild(removeTd);

    basketTableBody.appendChild(tr);
    grandTotal += lineTotal;
  });

  basketGrandTotalEl.textContent = grandTotal.toFixed(2);
}

/* ------------------------------------------------------------------
  EXPORT CSV & PDF
------------------------------------------------------------------ */
exportCsvBtn.onclick = () => {
  if (basket.length === 0) return;

  // Construct CSV lines
  const lines = [];
  lines.push(["Item", "Quantity", "Unit Price", "Line Total"]);
  basket.forEach(item => {
    const lineTotal = item.quantity * item.unitPrice;
    lines.push([
      item.itemName,
      item.quantity,
      item.unitPrice.toFixed(2),
      lineTotal.toFixed(2)
    ]);
  });
  // Convert to CSV string
  const csvContent = lines.map(line => line.join(",")).join("\n");

  // Trigger download
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.setAttribute("href", url);
  link.setAttribute("download", "quote_basket.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
};

exportPdfBtn.onclick = () => {
  if (basket.length === 0) return;

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(12);
  doc.text("Quote Basket", 10, 10);

  // Table headers
  let yPos = 20;
  doc.text("Item", 10, yPos);
  doc.text("Qty", 60, yPos);
  doc.text("Unit Price", 80, yPos);
  doc.text("Line Total", 120, yPos);

  yPos += 10;
  let grandTotal = 0;

  basket.forEach(item => {
    const lineTotal = item.quantity * item.unitPrice;

    doc.text(String(item.itemName), 10, yPos);
    doc.text(String(item.quantity), 60, yPos);
    doc.text(item.unitPrice.toFixed(2), 80, yPos);
    doc.text(lineTotal.toFixed(2), 120, yPos);

    yPos += 10;
    grandTotal += lineTotal;
  });

  yPos += 10;
  doc.text(`Grand Total: $${grandTotal.toFixed(2)}`, 10, yPos);

  doc.save("quote_basket.pdf");
};
</script>
</body>
</html>