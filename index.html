<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<meta charset="UTF-8">
<title>In A Minnit Pricing Tool 2.2.0</title>
<style>
:root{--bg:#f7f7f7;--fg:#333;--header:#e0e0e0;--btn:#007bff;--btnh:#0056b3;--add:#28a745;--addh:#218838;--border:#aaa;--alt:#f9f9f9;--panel:#fff;--toast:#007bff;--toastfg:#fff;--rowHover:#e9f1ff}
.dark-mode{--bg:#222;--fg:#eee;--header:#444;--btn:#0d6efd;--btnh:#0a58ca;--add:#198754;--addh:#157347;--border:#555;--alt:#2a2a2a;--panel:#333;--toast:#0d6efd;--toastfg:#fff;--rowHover:#383838}
body{font-family:sans-serif;margin:1rem;background:var(--bg);color:var(--fg);transition:.3s}

/* Floating basket window */
#basketContainer{
  position:fixed;
  bottom:40px;
  right:40px;
  width:500px;
  max-height:70%;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:8px;
  box-shadow:0 4px 20px rgba(0,0,0,.25);
  z-index:2000;
  display:none;
  resize:both;
  overflow:auto;
}

/* Basket header with macOS-style controls */
#basketHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:.4rem .6rem;
  background:var(--header);
  border-bottom:1px solid var(--border);
  cursor:move;
}
#macControls{
  display:flex;
  gap:.4rem;
}
.mac-btn{
  width:12px;
  height:12px;
  border-radius:50%;
  display:inline-block;
}
.mac-close{background:#ff5f57}
.mac-min{background:#ffbd2e}
.mac-max{background:#28c840}
#basketHeader h3{margin:0;font-size:1rem}

#basketContent{padding:.5rem}
#basketTable{table-layout:fixed;width:100%;border-collapse:collapse}
#basketTable th,#basketTable td{border:1px solid var(--border);padding:.28rem;text-align:center}
#basketTable tbody tr:hover{background:var(--rowHover)}
.sort-handle{cursor:move;user-select:none;text-align:left;font-size:1.1rem;min-width:2em}
.qty-input{width:48px;text-align:center}
.remove-btn{color:red;font-weight:bold;cursor:pointer}

.editable{background:#fff;border:1px solid var(--border);padding:.2rem .3rem;border-radius:4px}
.item-input{display:block;width:100%;min-height:2.4em;resize:vertical;overflow:auto;white-space:pre-wrap;line-height:1.22}
.price-input{max-width:90px;text-align:right}
.gst-cell{text-align:center}
.gst-input{width:18px;height:18px}
/* basket window states */
#basketContainer.bwin{position:fixed;z-index:2000;border:1px solid var(--border);border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.25);background:var(--panel);overflow:hidden}
#basketContainer.min{height:34px!important;overflow:hidden}
#basketContainer.max{top:5%!important;left:5%!important;width:90%!important;height:90%!important;right:auto!important;bottom:auto!important}
#basketContainer.mobile{left:0!important;right:0!important;bottom:0!important;top:auto!important;width:auto!important;height:70%!important;border-radius:14px 14px 0 0}
#basketContainer.dragging{opacity:.98}
#basketContainer .resize-handle{position:absolute;right:6px;bottom:6px;width:14px;height:14px;cursor:nwse-resize;opacity:.6}
#basketContainer .resize-handle:before{content:"";position:absolute;right:2px;bottom:2px;width:10px;height:10px;border-right:2px solid var(--border);border-bottom:2px solid var(--border);transform:skew(-10deg)}
#basketHeader{user-select:none}
.dragging *{user-select:none!important}
/* reopen FAB */
#basketReopen{position:fixed;right:18px;bottom:18px;z-index:1999;background:var(--btn);color:#fff;border:none;border-radius:999px;padding:.55rem .9rem;box-shadow:0 6px 18px rgba(0,0,0,.25);cursor:pointer;display:none}
#basketReopen:hover{background:var(--btnh)}
/* hide basket in print */
@media print{#basketContainer,#basketReopen{display:none!important}}
/* basket window states */
#basketContainer.bwin{position:fixed;z-index:2000;border:1px solid var(--border);border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.25);background:var(--panel);overflow:hidden}
#basketContainer.min{height:34px!important;overflow:hidden}
#basketContainer.max{top:5%!important;left:5%!important;width:90%!important;height:90%!important;right:auto!important;bottom:auto!important}
#basketContainer.mobile{left:0!important;right:0!important;bottom:0!important;top:auto!important;width:auto!important;height:70%!important;border-radius:14px 14px 0 0}
#basketContainer.dragging{opacity:.98}
#basketContainer .resize-handle{position:absolute;right:6px;bottom:6px;width:14px;height:14px;cursor:nwse-resize;opacity:.6}
#basketContainer .resize-handle:before{content:"";position:absolute;right:2px;bottom:2px;width:10px;height:10px;border-right:2px solid var(--border);border-bottom:2px solid var(--border);transform:skew(-10deg)}
#basketHeader{user-select:none}
.dragging *{user-select:none!important}
/* title bar & traffic lights */
#basketHeader.titlebar{display:flex;align-items:center;justify-content:space-between;background:var(--header);padding:.35rem .5rem;border-bottom:1px solid var(--border)}
#basketHeader .title-left{display:flex;align-items:center;gap:.5rem}
#basketHeader .tl{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:.35rem;box-shadow:inset 0 0 0 1px rgba(0,0,0,.25);cursor:pointer}
#basketHeader .tl.red{background:#ff5f57}
#basketHeader .tl.yellow{background:#febc2e}
#basketHeader .tl.green{background:#28c840}
#basketHeader .title-actions button{margin-left:.35rem}
/* reopen FAB */
#basketReopen{position:fixed;right:18px;bottom:18px;z-index:1999;background:var(--btn);color:#fff;border:none;border-radius:999px;padding:.55rem .9rem;box-shadow:0 6px 18px rgba(0,0,0,.25);cursor:pointer;display:none}
#basketReopen:hover{background:var(--btnh)}
/* hide basket in print */
@media print{#basketContainer,#basketReopen{display:none!important}}
</style>
</head>
<body>
<h1>In A Minnit Pricing Tool 2.2.0</h1>
<p><em>Beta version – features subject to change. Always check your work. Report bugs to marco@inaminnit.com.au</em></p>
<button id="darkModeToggle">Toggle Dark Mode</button>
<div id="sheetTabs"></div>
<div id="status" style="margin:.5rem 0;font-size:.9rem"></div>
<div id="manualLoad" style="display:none;margin:.5rem 0"><label class="search-label">Load workbook:</label><input type="file" id="xlsxPicker" accept=".xlsx"></div>
<div id="sheetContainer"></div>

<div id="basketContainer" class="bwin" style="display:none; left:16px; top:auto; right:16px; bottom:16px; width:auto; height:auto;">
  <div class="resize-handle" id="basketResize"></div>
  <div id="basketHeader" class="titlebar">
    <div class="title-left">
      <span class="tl red" id="closeBasket" aria-label="Close" title="Close"></span>
      <span class="tl yellow" id="minBasket" aria-label="Minimise" title="Minimise"></span>
      <span class="tl green" id="maxBasket" aria-label="Full screen" title="Full screen"></span>
      <h3 style="margin:0">Quote Basket</h3><span id="toast"></span>
    </div>
    <div class="title-actions">
      <button id="addCustomBtn">Add custom line</button>
      <button id="clearBasketBtn">Clear</button>
      <button id="exportCsvBtn">Export quote CSV</button>
      <button id="toggleBasketBtn">Hide Basket</button>
    </div>
  </div>
  <div id="basketContent">
    <table id="basketTable">
      <thead><tr>
        <th class="sort-handle">≡</th><th>Item</th><th>Quantity</th>
        <th>Price Ex. GST</th><th>GST</th>
        <th>Line Total Ex. GST</th><th>GST</th><th>Line Total</th><th>Remove</th>
      </tr></thead>
      <tbody></tbody><tfoot></tfoot>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
// MacOS control behaviours
const basket = document.getElementById('basketContainer');
document.getElementById('closeBasket').onclick = ()=> basket.style.display='none';
document.getElementById('minBasket').onclick = ()=> basket.style.height='40px';
document.getElementById('maxBasket').onclick = ()=> {basket.style.width='90%'; basket.style.height='90%'; basket.style.top='5%'; basket.style.left='5%';};
// Temporary trigger to show basket for testing
window.addEventListener('keydown',e=>{if(e.key==='b'){basket.style.display='block';}});
</script>
<button id="basketReopen" title="Open basket">Basket</button>
<script>
(function(){
  // ===== Basket Window Controller (floating, draggable, resizable, macOS controls, persistence) =====
  var WIN_KEY='iam_basket_window_v1';
  var el=document.getElementById('basketContainer');
  var header=document.getElementById('basketHeader');
  var btnClose=document.getElementById('closeBasket');
  var btnMin=document.getElementById('minBasket');
  var btnMax=document.getElementById('maxBasket');
  var reopen=document.getElementById('basketReopen');
  var resizeHandle=document.getElementById('basketResize');
  var state={mode:'normal',x:null,y:null,w:Math.max(420, window.innerWidth - 32),h:Math.max(240, Math.floor(window.innerHeight*0.4))};
  // Load state
  try{ var raw=localStorage.getItem(WIN_KEY); if(raw){ var s=JSON.parse(raw); if(s && typeof s==='object'){ for(var k in s){ state[k]=s[k]; } } } }catch(e){}
  function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
  function isMobile(){ return window.innerWidth < 768; }
  function defaultXY(){ var top = Math.max(16, window.innerHeight - state.h - 16); var left = 16; return {left:left, top:top}; }; }
  function save(){ try{ localStorage.setItem(WIN_KEY, JSON.stringify(state)); }catch(e){} }
  function showReopen(v){ reopen.style.display = v?'block':'none'; }
  function apply(){
    if(state.mode==='hidden'){ el.style.display='none'; showReopen(true); return; }
    showReopen(false); el.style.display='block';
    // stretch to full width by default (unless maximized/minimized/mobile)
    el.classList.remove('min','max','mobile');
    if(isMobile()) el.classList.add('mobile');
    if(state.mode==='min') el.classList.add('min');
    if(state.mode==='max') el.classList.add('max');
    if(state.mode==='max'){
      // handled by CSS
    } else if(el.classList.contains('mobile')){
      // bottom sheet by CSS; width auto
    } else {
      if(state.x==null || state.y==null){ var d=defaultXY(); state.x=d.left; state.y=d.top; }
      el.style.left=state.x+'px'; el.style.top=state.y+'px';
      // full width: use right instead of fixed width when near full stretch
      var wantFull = Math.abs(state.w - (window.innerWidth-32)) < 24; // heuristic
      if(wantFull){ el.style.right='16px'; el.style.left='16px'; el.style.width='auto'; }
      else { el.style.right='auto'; el.style.width=state.w+'px'; }
      el.style.height=(state.mode==='min'?34:state.h)+'px';
    }
    save();
  }
  function setMode(m){ state.mode=m; apply(); }
  function toggleMax(){ setMode(state.mode==='max' ? 'normal' : 'max'); }
  // Dragging
  var dragging=false, sx=0, sy=0, sl=0, st=0;
  header.addEventListener('mousedown', function(e){ if(state.mode!=='normal' || isMobile()) return; dragging=true; document.body.classList.add('dragging'); sx=e.clientX; sy=e.clientY; var r=el.getBoundingClientRect(); sl=r.left; st=r.top; window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp); e.preventDefault(); });
  function onMove(e){ if(!dragging) return; var nx=clamp(sl+(e.clientX-sx), 0, window.innerWidth - el.offsetWidth); var ny=clamp(st+(e.clientY-sy), 0, window.innerHeight - 34); el.style.left=nx+'px'; el.style.top=ny+'px'; state.x=nx; state.y=ny; }
  function onUp(){ if(!dragging) return; dragging=false; document.body.classList.remove('dragging'); window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); save(); }
  // Resizing (bottom-right)
  var resizing=false, rw=0, rh=0, rsx=0, rsy=0, rl=0, rt=0;
  resizeHandle.addEventListener('mousedown', function(e){ if(state.mode!=='normal') return; resizing=true; document.body.classList.add('dragging'); var r=el.getBoundingClientRect(); rw=r.width; rh=r.height; rl=r.left; rt=r.top; rsx=e.clientX; rsy=e.clientY; window.addEventListener('mousemove', onResize); window.addEventListener('mouseup', onResizeUp); e.preventDefault(); e.stopPropagation(); });
  function onResize(e){ if(!resizing) return; var nw=clamp(rw+(e.clientX-rsx), 360, window.innerWidth-rl-8); var nh=clamp(rh+(e.clientY-rsy), 200, window.innerHeight-rt-8); el.style.width=nw+'px'; el.style.height=nh+'px'; state.w=nw; state.h=nh; }
  function onResizeUp(){ if(!resizing) return; resizing=false; document.body.classList.remove('dragging'); window.removeEventListener('mousemove', onResize); window.removeEventListener('mouseup', onResizeUp); save(); }
  // Controls
  if(btnClose) btnClose.onclick=function(){ setMode('hidden'); };
  if(btnMin) btnMin.onclick=function(){ setMode('min'); };
  if(btnMax) btnMax.onclick=function(){ toggleMax(); };
  if(reopen) reopen.onclick=function(){ setMode('normal'); };
  // Keyboard shortcuts
  window.addEventListener('keydown', function(e){ var mod=e.metaKey||e.ctrlKey; if(e.key==='Escape'){ setMode('hidden'); }
    else if(mod && (e.key==='m' || e.key==='M')){ setMode('min'); e.preventDefault(); }
    else if(mod && (e.key==='Enter' || e.keyCode===13)){ toggleMax(); e.preventDefault(); }
  });
  // Focus trap when maximized
  document.addEventListener('keydown', function(e){ if(state.mode!=='max') return; if(e.key!=='Tab') return; var focusables=el.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])'); if(!focusables.length) return; var first=focusables[0], last=focusables[focusables.length-1]; var cur=document.activeElement; if(e.shiftKey){ if(cur===first||!el.contains(cur)){ last.focus(); e.preventDefault(); } } else { if(cur===last||!el.contains(cur)){ first.focus(); e.preventDefault(); } } });
  // Mobile adapt on resize
  window.addEventListener('resize', function(){ apply(); });
  // Initial apply
  apply();
})();
</script>
</body>
</html>
