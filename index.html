<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>In A Minnit Pricing Tool 1.0</title>
  <style>
    /* Global Page Styles */
    body {
      font-family: sans-serif;
      margin: 1rem;
      background-color: #f7f7f7;
    }
    h1 {
      margin-bottom: 0.2rem;
    }
    p {
      margin-top: 0;
      margin-bottom: 2rem;
    }
    
    /* Tab-Based Navigation for Sheets */
    #sheetTabs {
      border-bottom: 1px solid #aaa;
      margin-bottom: 1rem;
    }
    #sheetTabs button {
      background: none;
      border: none;
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-size: 1rem;
      margin-right: 0.5rem;
    }
    #sheetTabs button.active {
      border-bottom: 2px solid #007bff;
      font-weight: bold;
    }
    
    /* Main Sheet Container – reserve space at bottom for fixed basket */
    #sheetContainer {
      margin-bottom: 150px; /* ensure content isn’t hidden behind basket */
    }
    /* Main Table Styles */
    #sheetContainer table {
      border-collapse: collapse;
      width: 100%;
    }
    /* Use a thead for sticky headers */
    #sheetContainer thead th {
      position: sticky;
      top: 0;
      background-color: #e0e0e0;
      border: 1px solid #aaa;
      padding: 0.5rem;
      text-align: center;
      z-index: 2;
    }
    #sheetContainer tbody td {
      border: 1px solid #aaa;
      padding: 0.5rem;
      text-align: left;
    }
    /* More pronounced row hover */
    #sheetContainer tbody tr:hover {
      background-color: #dddddd;
    }
    
    /* Live Search Container */
    .search-container {
      margin-bottom: 1rem;
      padding: 0.5rem;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .search-label {
      font-weight: bold;
      margin-right: 0.5rem;
    }
    .search-input {
      padding: 0.4rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 200px;
    }
    
    /* Green "Add to Basket" Button for Main Table (placed on far left) */
    .add-button {
      background-color: #28a745;
      border: none;
      color: #fff;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    .add-button:hover {
      background-color: #218838;
    }
    
    /* Fixed Basket at Bottom */
    #basketContainer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: #fff;
      border-top: 1px solid #aaa;
      padding: 1rem;
      z-index: 1000;
    }
    #basketContainer h3 {
      margin-top: 0;
      margin-bottom: 0.5rem;
    }
    /* Basket Table */
    #basketTable {
      width: 100%;
      border-collapse: collapse;
    }
    #basketTable th,
    #basketTable td {
      border: 1px solid #aaa;
      padding: 0.5rem;
      text-align: left;
    }
    
    /* Quantity Controls in Basket */
    .qty-controls {
      display: flex;
      align-items: center;
    }
    .qty-controls button {
      margin: 0 5px;
      cursor: pointer;
    }
    .qty-input {
      width: 60px;
      text-align: center;
    }
    .remove-btn {
      color: red;
      font-weight: bold;
      cursor: pointer;
    }
    
    /* Visual feedback for copy-to-clipboard */
    .copied-cell {
      background-color: #c8e6c9 !important;
      transition: background-color 0.3s ease;
    }
    
    /* Highlighted text from live search */
    .highlight {
      background-color: yellow;
    }
  </style>
</head>
<body>
  <h1>In A Minnit Pricing Tool 1.0</h1>
  <p><em>Beta version – features subject to change. Always check your work. Report bugs to Marco.</em></p>
  
  <!-- Tab-Based Navigation for Sheets -->
  <div id="sheetTabs"></div>
  
  <!-- Main Sheet Container -->
  <div id="sheetContainer"></div>
  
  <!-- Fixed Basket at Bottom -->
  <div id="basketContainer">
    <h3>Quote Basket</h3>
    <div class="basket-actions">
      <button id="exportCsvBtn">Export quote CSV</button>
    </div>
    <table id="basketTable">
      <thead>
        <tr>
          <th>Item</th>
          <th>Quantity</th>
          <th>Price Ex. GST</th>
          <th>Price Inc. GST</th>
          <th>Line Total Ex. GST</th>
          <th>Line Total Inc. GST</th>
          <th>Remove</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p><strong>Grand Total (Ex. GST):</strong> $<span id="grandEx">0.00</span></p>
    <p><strong>Grand Total (Inc. GST):</strong> $<span id="grandInc">0.00</span></p>
  </div>
  
  <!-- Include SheetJS Library -->
  <script src="xlsx.full.min.js"></script>
  <script>
  (function() {
    "use strict";
    
    /* ---------------- CONFIGURATION ---------------- */
    const PRICE_COLUMNS_EX = ["Rate Ex. GST", "Price Ex. GST"];
    const PRICE_COLUMN_INC = "Price Inc. GST";
    
    /* ---------------- GLOBAL VARIABLES ---------------- */
    let basket = [];
    let workbookGlobal = null;
    
    /* ---------------- DOM ELEMENTS ---------------- */
    const sheetTabs = document.getElementById("sheetTabs");
    const sheetContainer = document.getElementById("sheetContainer");
    const basketContainer = document.getElementById("basketContainer");
    const basketTableBody = document.querySelector("#basketTable tbody");
    const grandExEl = document.getElementById("grandEx");
    const grandIncEl = document.getElementById("grandInc");
    const exportCsvBtn = document.getElementById("exportCsvBtn");
    
    /* ---------------- FETCH & PARSE EXCEL ---------------- */
    fetch("myFile.xlsx")
      .then(response => response.arrayBuffer())
      .then(data => {
        workbookGlobal = XLSX.read(data, { type: "array" });
        const sheetNames = Object.keys(workbookGlobal.Sheets);
        buildTabs(sheetNames);
        // Automatically display first sheet:
        if(sheetNames.length) {
          setActiveTab(sheetNames[0]);
          showSheet(sheetNames[0]);
        }
      })
      .catch(err => {
        console.error("Failed to fetch Excel file:", err);
        sheetContainer.textContent = "Error fetching Excel file.";
      });
    
    /* ---------------- TAB NAVIGATION ---------------- */
    function buildTabs(sheetNames) {
      sheetTabs.innerHTML = "";
      sheetNames.forEach(name => {
        const btn = document.createElement("button");
        btn.textContent = name;
        btn.dataset.sheetName = name;
        btn.onclick = () => {
          setActiveTab(name);
          showSheet(name);
        };
        sheetTabs.appendChild(btn);
      });
    }
    
    function setActiveTab(activeName) {
      Array.from(sheetTabs.children).forEach(btn => {
        if (btn.dataset.sheetName === activeName) {
          btn.classList.add("active");
        } else {
          btn.classList.remove("active");
        }
      });
    }
    
    /* ---------------- SHOW SHEET & BUILD MAIN TABLE ---------------- */
    function showSheet(sheetName) {
      const sheet = workbookGlobal.Sheets[sheetName];
      let rows = XLSX.utils.sheet_to_json(sheet, {
        header: 1,
        defval: "",
        blankrows: true
      });
      const maxCols = Math.max(...rows.map(r => r.length));
      rows.forEach(row => {
        while (row.length < maxCols) row.push("");
      });
      buildTable(rows);
    }
    
    function buildTable(rows) {
      sheetContainer.innerHTML = "";
      const wrapper = document.createElement("div");
      wrapper.classList.add("sheet-view");
      sheetContainer.appendChild(wrapper);
      
      // Create a search container with extra spacing
      const searchDiv = document.createElement("div");
      searchDiv.classList.add("search-container");
      const searchLabel = document.createElement("label");
      searchLabel.classList.add("search-label");
      searchLabel.textContent = "Search items:";
      const searchInput = document.createElement("input");
      searchInput.type = "text";
      searchInput.placeholder = "Type to filter...";
      searchInput.classList.add("search-input");
      searchDiv.appendChild(searchLabel);
      searchDiv.appendChild(searchInput);
      wrapper.appendChild(searchDiv);
      
      // Table container
      const tableContainer = document.createElement("div");
      wrapper.appendChild(tableContainer);
      
      // Get header row from first row of data
      const headers = rows.length > 0 ? rows[0].map(h => String(h).trim()) : [];
      
      // Build table with sticky header (using thead and tbody)
      function buildFilteredTable(filteredRows) {
        tableContainer.innerHTML = "";
        const table = document.createElement("table");
        
        // Create thead for header row
        if (filteredRows.length > 0) {
          const thead = document.createElement("thead");
          const trHead = document.createElement("tr");
          // Add an extra empty header cell for the add-to-basket button column
          const emptyTh = document.createElement("th");
          emptyTh.textContent = "";
          trHead.appendChild(emptyTh);
          filteredRows[0].forEach((cell, colIndex) => {
            const th = document.createElement("th");
            th.textContent = cell;
            trHead.appendChild(th);
          });
          thead.appendChild(trHead);
          table.appendChild(thead);
        }
        
        // Create tbody for data rows
        const tbody = document.createElement("tbody");
        for (let i = 1; i < filteredRows.length; i++) {
          const row = filteredRows[i];
          const tr = document.createElement("tr");
          // Add green add-to-basket button at far left
          const addCell = document.createElement("td");
          const addBtn = document.createElement("button");
          addBtn.classList.add("add-button");
          addBtn.textContent = "+";
          addBtn.onclick = () => addToBasket(filteredRows[i], headers);
          addCell.appendChild(addBtn);
          tr.appendChild(addCell);
          
          row.forEach((cellValue, colIndex) => {
            const td = document.createElement("td");
            let formatted = formatIfPrice(i, headers[colIndex], cellValue);
            // If search is active, highlight matching text
            if (searchInput.value.trim() !== "") {
              formatted = highlightText(formatted, searchInput.value.trim());
              td.innerHTML = formatted;
            } else {
              td.textContent = formatted;
            }
            // For price columns, force bold styling
            if (headers[colIndex] &&
               (headers[colIndex].toLowerCase().includes("ex. gst") ||
                headers[colIndex].toLowerCase().includes("inc. gst"))) {
              td.style.fontWeight = "bold";
            }
            // Click-to-copy feature with visual feedback
            td.onclick = (e) => {
              // Prevent interference with the add button cell
              if (e.target.tagName.toLowerCase() === "button") return;
              copyCellText(td);
            };
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        }
        table.appendChild(tbody);
        tableContainer.appendChild(table);
      }
      
      // Initially build table with all rows
      buildFilteredTable(rows);
      
      // Add live search filtering with highlighted suggestions
      searchInput.addEventListener("input", () => {
        const filterVal = searchInput.value.trim().toLowerCase();
        if (!filterVal) {
          buildFilteredTable(rows);
          return;
        }
        const filtered = rows.filter((r, i) => {
          if (i === 0) return true;
          return r.some(cell => String(cell).toLowerCase().includes(filterVal));
        });
        buildFilteredTable(filtered);
      });
    }
    
    function formatIfPrice(rowIndex, colHeader, cellValue) {
      if (rowIndex === 0) return cellValue;
      const lower = (colHeader || "").toLowerCase();
      if (lower.includes("ex. gst") || lower.includes("inc. gst")) {
        const parsed = parseFloat(cellValue);
        if (!isNaN(parsed)) return parsed.toFixed(2);
      }
      return cellValue;
    }
    
    /* ---------------- LIVE SEARCH HIGHLIGHT FUNCTION ---------------- */
    function highlightText(text, term) {
      if (!term) return text;
      // Escape special characters for regex
      const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const regex = new RegExp(`(${escapedTerm})`, 'gi');
      return text.toString().replace(regex, '<span class="highlight">$1</span>');
    }
    
    /* ---------------- CLICK-TO-COPY FUNCTION ---------------- */
    function copyCellText(td) {
      const text = td.textContent;
      navigator.clipboard.writeText(text)
        .then(() => {
          td.classList.add("copied-cell");
          setTimeout(() => td.classList.remove("copied-cell"), 300);
          console.log("Copied:", text);
        })
        .catch(err => console.error("Clipboard error:", err));
    }
    
    /* ---------------- BASKET FUNCTIONS ---------------- */
    function addToBasket(row, headers) {
      const itemName = row[0] || "Untitled";
      let exPrice = null;
      let incPrice = null;
      for (let i = 0; i < headers.length; i++) {
        const head = headers[i];
        const val = parseFloat(row[i]);
        if (PRICE_COLUMNS_EX.includes(head) && !isNaN(val)) {
          exPrice = val;
        }
        if (head === PRICE_COLUMN_INC && !isNaN(val)) {
          incPrice = val;
        }
      }
      const existing = basket.find(it => it.itemName === itemName);
      if (existing) {
        existing.quantity = parseFloat(existing.quantity) + 1;
      } else {
        basket.push({
          itemName,
          quantity: 1,
          exPrice,
          incPrice
        });
      }
      renderBasket();
    }
    
    function renderBasket() {
      if (basket.length === 0) {
        basketContainer.style.display = "none";
        return;
      }
      basketContainer.style.display = "block";
      basketTableBody.innerHTML = "";
      let totalEx = 0;
      let totalInc = 0;
      basket.forEach((item, index) => {
        const tr = document.createElement("tr");
        
        // Item Name
        const nameTd = document.createElement("td");
        nameTd.textContent = item.itemName;
        tr.appendChild(nameTd);
        
        // Quantity controls (with +/- buttons and numeric input)
        const qtyTd = document.createElement("td");
        const qtyControls = document.createElement("div");
        qtyControls.classList.add("qty-controls");
        const minusBtn = document.createElement("button");
        minusBtn.textContent = "-";
        minusBtn.onclick = () => {
          let q = parseFloat(item.quantity) || 1;
          q = q - 1;
          if (q < 1) q = 1;
          item.quantity = q;
          renderBasket();
        };
        const qtyInput = document.createElement("input");
        qtyInput.type = "number";
        qtyInput.step = "0.1";
        qtyInput.classList.add("qty-input");
        qtyInput.value = item.quantity;
        qtyInput.onchange = () => {
          let val = parseFloat(qtyInput.value);
          if (isNaN(val) || val < 1) val = 1;
          item.quantity = val;
          renderBasket();
        };
        const plusBtn = document.createElement("button");
        plusBtn.textContent = "+";
        plusBtn.onclick = () => {
          let q = parseFloat(item.quantity) || 1;
          q = q + 1;
          item.quantity = q;
          renderBasket();
        };
        qtyControls.appendChild(minusBtn);
        qtyControls.appendChild(qtyInput);
        qtyControls.appendChild(plusBtn);
        qtyTd.appendChild(qtyControls);
        tr.appendChild(qtyTd);
        
        // Price Ex. GST (bold)
        const priceExTd = document.createElement("td");
        priceExTd.textContent = item.exPrice !== null ? item.exPrice.toFixed(2) : "N/A";
        priceExTd.style.fontWeight = "bold";
        tr.appendChild(priceExTd);
        
        // Price Inc. GST (bold)
        const priceIncTd = document.createElement("td");
        priceIncTd.textContent = item.incPrice !== null ? item.incPrice.toFixed(2) : "N/A";
        priceIncTd.style.fontWeight = "bold";
        tr.appendChild(priceIncTd);
        
        // Line Total Ex. GST
        const qVal = parseFloat(item.quantity) || 1;
        const lineExTd = document.createElement("td");
        if (item.exPrice !== null) {
          const lineEx = qVal * item.exPrice;
          lineExTd.textContent = lineEx.toFixed(2);
          totalEx += lineEx;
        } else {
          lineExTd.textContent = "N/A";
        }
        tr.appendChild(lineExTd);
        
        // Line Total Inc. GST
        const lineIncTd = document.createElement("td");
        if (item.incPrice !== null) {
          const lineInc = qVal * item.incPrice;
          lineIncTd.textContent = lineInc.toFixed(2);
          totalInc += lineInc;
        } else {
          lineIncTd.textContent = "N/A";
        }
        tr.appendChild(lineIncTd);
        
        // Remove Button
        const removeTd = document.createElement("td");
        const removeBtn = document.createElement("span");
        removeBtn.textContent = "X";
        removeBtn.classList.add("remove-btn");
        removeBtn.onclick = () => {
          basket.splice(index, 1);
          renderBasket();
        };
        removeTd.appendChild(removeBtn);
        tr.appendChild(removeTd);
        
        basketTableBody.appendChild(tr);
      });
      grandExEl.textContent = totalEx.toFixed(2);
      grandIncEl.textContent = totalInc.toFixed(2);
    }
    
    /* ---------------- EXPORT CSV FUNCTION ---------------- */
    exportCsvBtn.onclick = () => {
      if (basket.length === 0) return;
      const lines = [];
      lines.push(["Item","Quantity","Price Ex. GST","Price Inc. GST","Line Ex","Line Inc"]);
      let totalEx = 0;
      let totalInc = 0;
      basket.forEach(item => {
        const q = parseFloat(item.quantity) || 1;
        const lineEx = (item.exPrice !== null) ? q * item.exPrice : 0;
        const lineInc = (item.incPrice !== null) ? q * item.incPrice : 0;
        totalEx += lineEx;
        totalInc += lineInc;
        lines.push([
          item.itemName,
          String(q),
          item.exPrice !== null ? item.exPrice.toFixed(2) : "N/A",
          item.incPrice !== null ? item.incPrice.toFixed(2) : "N/A",
          item.exPrice !== null ? lineEx.toFixed(2) : "N/A",
          item.incPrice !== null ? lineInc.toFixed(2) : "N/A"
        ]);
      });
      lines.push(["","","","Totals:", totalEx.toFixed(2), totalInc.toFixed(2)]);
      const csvContent = lines.map(line => line.join(",")).join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "quote_basket.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };
    
  })();
  </script>
</body>
</html>