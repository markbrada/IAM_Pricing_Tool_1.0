<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>In A Minnit Pricing Tool 1.0</title>
<style>
/* ---------- THEME ---------- */
:root{--bg:#f7f7f7;--fg:#333;--header:#e0e0e0;--btn:#007bff;--btnh:#0056b3;
--add:#28a745;--addh:#218838;--border:#aaa;--alt:#f9f9f9;--panel:#fff}
.dark-mode{--bg:#222;--fg:#eee;--header:#444;--btn:#0d6efd;--btnh:#0a58ca;
--add:#198754;--addh:#157347;--border:#555;--alt:#2a2a2a;--panel:#333}

body{font-family:sans-serif;margin:1rem;background:var(--bg);color:var(--fg);transition:.3s}
h1{margin:.2rem 0}p{margin:0 0 2rem}

#darkModeToggle{position:fixed;top:10px;right:10px;z-index:3000;background:var(--btn);color:#fff;border:none;padding:.5rem .75rem;border-radius:4px;cursor:pointer}
#darkModeToggle:hover{background:var(--btnh)}

#sheetTabs{border-bottom:1px solid var(--border);margin-bottom:1rem}
#sheetTabs button{background:none;border:none;padding:.5rem 1rem;margin-right:.5rem;font-size:1rem;color:var(--fg);cursor:pointer}
#sheetTabs button.active{border-bottom:2px solid var(--btn);font-weight:bold}

.search-container{margin-bottom:1rem;padding:.5rem;background:var(--panel);border:1px solid var(--border);border-radius:4px}
.search-label{font-weight:bold;margin-right:.5rem}
.search-input{padding:.4rem;border:1px solid var(--border);border-radius:4px;width:200px;background:var(--panel);color:var(--fg)}
.highlight{background:yellow}

table{border-collapse:collapse;width:100%}
thead th{position:sticky;top:0;background:var(--header);border:1px solid var(--border);padding:.5rem;text-align:center;z-index:2}
tbody td{border:1px solid var(--border);padding:.5rem}
tbody tr:nth-child(even){background:var(--alt)}
tbody tr:hover{background:#ccc}

details{margin-bottom:1rem}
summary{list-style:none;cursor:pointer;display:flex;align-items:center;gap:.5rem;padding:.4rem .6rem;border-radius:4px;background:var(--header);font-weight:bold}
summary::-webkit-details-marker{display:none}
summary:hover{background:var(--btn);color:#fff}

.cat-orange summary{background:#ffe9d6}.cat-orange summary:hover{background:#ffc999;color:#000}
.cat-blue   summary{background:#d8ebff}.cat-blue   summary:hover{background:#add6ff;color:#000}
.cat-brown  summary{background:#f2e6d9}.cat-brown  summary:hover{background:#e0cbb9;color:#000}
.cat-red    summary{background:#ffdede}.cat-red    summary:hover{background:#ffb7b7;color:#000}
.cat-yellow summary{background:#fff8d6}.cat-yellow summary:hover{background:#ffea9f;color:#000}
.cat-green  summary{background:#e6f9e5}.cat-green  summary:hover{background:#c4eac2;color:#000}

.add-button{background:var(--add);color:#fff;border:none;padding:.3rem .6rem;border-radius:4px;font-weight:bold;cursor:pointer}
.add-button:hover{background:var(--addh)}

#basketContainer{position:fixed;bottom:0;left:0;right:0;max-height:40%;background:var(--panel);border-top:1px solid var(--border);padding:1rem;box-shadow:0 -2px 5px rgba(0,0,0,.1);z-index:1000;overflow-y:auto}
#basketHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}
#basketHeader h3{margin:0}
#basketHeader button{background:var(--btn);color:#fff;border:none;padding:.3rem .6rem;border-radius:4px;cursor:pointer}
#basketHeader button:hover{background:var(--btnh)}
#basketTable th,#basketTable td{border:1px solid var(--border);padding:.5rem}
#basketTable tbody tr:nth-child(even){background:var(--alt)}
.sort-handle{cursor:move;user-select:none;text-align:center;font-size:1.2rem;width:2em}
.qty-input{width:60px;text-align:center}
.remove-btn{color:red;font-weight:bold;cursor:pointer}

#toast{margin-left:1rem;background:var(--btn);color:#fff;padding:.3rem .6rem;border-radius:4px;opacity:0;transition:.3s}
#toast.show{opacity:1}
.copied-cell{background:#c8e6c9!important;transition:.15s}
</style>
</head>
<body>
<h1>In A Minnit Pricing Tool 1.0</h1>
<p><em>Beta – features subject to change. Check your work. Report bugs to Marco.</em></p>
<button id="darkModeToggle">Toggle Dark Mode</button>

<div id="sheetTabs"></div>
<div id="sheetContainer"></div>

<!-- BASKET -->
<div id="basketContainer">
  <div id="basketHeader">
    <div style="display:flex;align-items:center;gap:.5rem">
      <h3>Quote Basket</h3><span id="toast"></span>
    </div>
    <div>
      <button id="exportCsvBtn">Export quote CSV</button>
      <button id="toggleBasketBtn">Hide Basket</button>
    </div>
  </div>
  <div id="basketContent">
    <table id="basketTable">
      <thead><tr><th class="sort-handle">≡</th><th>Item</th><th>Quantity</th><th>Price Ex. GST</th><th>Price Inc. GST</th><th>Line Total Ex. GST</th><th>Line Total Inc. GST</th><th>Remove</th></tr></thead>
      <tbody></tbody><tfoot></tfoot>
    </table>
  </div>
</div>

<script src="xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
(()=>{"use strict";
/* ---------- CONSTANTS & META ---------- */
const PRICE_EX=["Rate Ex. GST","Price Ex. GST"], PRICE_INC="Price Inc. GST";
const PRICE_META=[
  ["bannister rail","cat-orange","🛠️"],
  ["stainless steel grabrail","cat-orange","🛠️"],
  ["aluminium grabrail, powder coated","cat-orange","🛠️"],
  ["shower parts","cat-blue","🚿"],
  ["plumbing","cat-blue","🔧"],
  ["door components","cat-brown","🚪"],
  ["fire safety","cat-red","🧯"],
  ["anti slip solutions","cat-yellow","🥾"],
  ["travel","cat-green","🛻"]
];
const RATE_META=[
  ["property maintenance","cat-green","🛠️"],
  ["cleaning","cat-green","🧹"],
  ["plumbing","cat-green","🔧"],
  ["electrical","cat-green","⚡️"],
  ["weekend work","cat-green","📆"],
  ["skip bin","cat-green","🚛"],
  ["travel","cat-green","🛻"]
];
const PRICE_MAP=Object.fromEntries(PRICE_META.map((m,i)=>[m[0],{idx:i,cls:m[1],emo:m[2]}]));
const RATE_MAP =Object.fromEntries(RATE_META .map((m,i)=>[m[0],{idx:i,cls:m[1],emo:m[2]}]));
const norm=s=>s.toLowerCase().replace(/[^a-z0-9 ]+/g," ").replace(/\s+/g," ").trim();

/* fuzzy match to meta */
function meta(sheet, raw){
  const tbl = sheet.toLowerCase().includes("standard")?RATE_META:PRICE_META;
  const map = sheet.toLowerCase().includes("standard")?RATE_MAP :PRICE_MAP;
  const n   = norm(raw);
  for(const [key] of tbl) if(n&&n.includes(key)) return map[key];
  if(n.includes("travel")) return map["travel"];
  return null;          // skip unknown
}

/* ---------- GLOBAL STATE ---------- */
let wb=null,basket=[];
const $=q=>document.querySelector(q), $$=q=>document.querySelectorAll(q);

/* ---------- DARK MODE ---------- */
$("#darkModeToggle").onclick=()=>document.body.classList.toggle("dark-mode");

/* ---------- TOAST ---------- */
const toast=$("#toast");
function pop(msg,undo){
  toast.textContent=msg;toast.classList.add("show");
  toast.onclick=undo?()=>{undo();toast.classList.remove("show");}:null;
  setTimeout(()=>toast.classList.remove("show"),3000);
}

/* ---------- LOAD EXCEL ---------- */
fetch("myFile.xlsx").then(r=>r.arrayBuffer()).then(buf=>{
  wb=XLSX.read(buf,{type:"array"});
  Object.keys(wb.Sheets).forEach((name,i)=>{
    const b=document.createElement("button");b.textContent=name;
    b.onclick=()=>{[...$$("#sheetTabs button")].forEach(x=>x.classList.toggle("active",x===b));build(name)};
    if(i===0){b.classList.add("active");build(name)}
    $("#sheetTabs").appendChild(b);
  });
});

/* ---------- BUILD SHEET ---------- */
function build(sheetName){
  const rows=XLSX.utils.sheet_to_json(wb.Sheets[sheetName],{header:1,defval:""});
  const header=rows[0].map(h=>String(h).trim()), catIdx=header.indexOf("Category");
  $("#sheetContainer").innerHTML='<div class="search-container"><label class="search-label">Search items:</label><input class="search-input" placeholder="Type to filter..."></div><div id="wrap"></div>';
  const search=$("#sheetContainer .search-input"), wrap=$("#wrap");
  const data=rows.slice(1);

  function render(arr,term=""){
    wrap.innerHTML="";
    const buckets={};
    arr.forEach(row=>{
      const m=meta(sheetName,row[catIdx]||"");
      if(!m) return;
      (buckets[m.idx]=buckets[m.idx]||[]).push(row);
    });
    const table=sheetName.toLowerCase().includes("standard")?RATE_META:PRICE_META;
    table.forEach(([key,cls,emo],idx)=>{
      const det=document.createElement("details");det.open=!!term;det.className=cls;
      det.innerHTML=`<summary>${emo}&nbsp;&nbsp;${key.charAt(0).toUpperCase()+key.slice(1)}</summary>`;
      const tbl=document.createElement("table");det.appendChild(tbl);
      tbl.innerHTML='<thead><tr><th></th>'+header.filter((_,i)=>i!==catIdx).map(h=>`<th>${h}</th>`).join("")+'</tr></thead><tbody></tbody>';
      const tbody=tbl.querySelector("tbody");
      const rows=buckets[idx]||[];
      if(!rows.length){
        const tr=document.createElement("tr");
        tr.innerHTML=`<td></td><td colspan="${header.length-1}"><em>No items in this section</em></td>`;
        tbody.appendChild(tr);
      }else{
        rows.forEach(row=>{
          const tr=document.createElement("tr");
          tr.innerHTML='<td><button class="add-button">+</button></td>';
          tr.querySelector("button").onclick=()=>{add(row,header);pop("Item added ✓",undoAdd)};
          row.forEach((cell,i)=>{
            if(i===catIdx) return;
            const td=document.createElement("td");const h=header[i].toLowerCase();
            let txt=/price|gst|rate/.test(h)&&!isNaN(cell)?(+cell).toFixed(2):cell;
            if(term) txt=txt.toString().replace(new RegExp(`(${term})`,"gi"),"<span class='highlight'>$1</span>");
            td.innerHTML=txt;if(/price|gst|rate/.test(h))td.style.fontWeight="bold";
            td.onclick=e=>{
              if(e.target.tagName==="BUTTON")return;
              navigator.clipboard.writeText(td.textContent).then(()=>{td.classList.add("copied-cell");void td.offsetWidth;setTimeout(()=>td.classList.remove("copied-cell"),150);});
            };
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      }
      wrap.appendChild(det);
    });
  }
  render(data);
  search.oninput=()=>{const t=search.value.trim().toLowerCase();render(t?data.filter(r=>r.some(c=>String(c).toLowerCase().includes(t))):data,t);}
}

/* ---------- BASKET ---------- */
const tbody=$("#basketTable tbody"), tfoot=$("#basketTable tfoot");
$("#toggleBasketBtn").onclick=e=>{
  const c=$("#basketContent");c.style.display=c.style.display==="none"?"block":"none";
  e.target.textContent=c.style.display==="none"?"Show Basket":"Hide Basket";
};
let lastAdd=null,lastDel=null;
function add(row,hdr){
  const item=row[hdr.indexOf("Item")]||"Item", ex=+row[hdr.findIndex(h=>PRICE_EX.includes(h))], inc=+row[hdr.indexOf(PRICE_INC)];
  const b=basket.find(x=>x.item===item); b?b.qty++:basket.push({item,qty:1,ex,inc});
  lastAdd=b||basket[basket.length-1]; refresh();
}
function undoAdd(){if(lastAdd){lastAdd.qty>1?lastAdd.qty--:basket.splice(basket.indexOf(lastAdd),1);lastAdd=null;refresh();}}
function undoDel(){if(lastDel){basket.splice(lastDel.i,0,lastDel.b);lastDel=null;refresh();}}
function refresh(){
  if(!basket.length){$("#basketContainer").style.display="none";return;} $("#basketContainer").style.display="block";
  tbody.innerHTML=""; let exTot=0, inTot=0;
  basket.forEach((b,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td class="sort-handle">≡</td><td>${b.item}</td>`;
    const qtd=document.createElement("td");
    qtd.innerHTML='<div class="qty-controls"><button>-</button><input type="number" step="0.1" class="qty-input"><button>+</button></div>';
    const [minus,input,plus]=qtd.querySelectorAll("button,input,button");
    input.value=b.qty; minus.onclick=()=>{b.qty=Math.max(1,b.qty-1);refresh();}; plus.onclick=()=>{b.qty++;refresh();}; input.onchange=()=>{b.qty=Math.max(1,parseFloat(input.value)||1);refresh();};
    tr.appendChild(qtd);
    tr.innerHTML+=`<td style="font-weight:bold">${isNaN(b.ex)?"N/A":b.ex.toFixed(2)}</td><td style="font-weight:bold">${isNaN(b.inc)?"N/A":b.inc.toFixed(2)}</td>`;
    const le=isNaN(b.ex)?0:b.qty*b.ex, li=isNaN(b.inc)?0:b.qty*b.inc; exTot+=le; inTot+=li;
    tr.innerHTML+=`<td>${isNaN(b.ex)?"N/A":le.toFixed(2)}</td><td>${isNaN(b.inc)?"N/A":li.toFixed(2)}</td>`;
    const del=document.createElement("td");del.innerHTML='<span class="remove-btn">X</span>';
    del.firstChild.onclick=()=>{lastDel={b,i};tr.classList.add("fade-out");setTimeout(()=>{basket.splice(i,1);refresh();pop("Item removed ↩",undoDel);},300);};
    tr.appendChild(del); tbody.appendChild(tr);
  });
  tfoot.innerHTML=`<tr><td colspan="5" style="text-align:right;font-weight:bold">Grand Totals:</td><td style="font-weight:bold">${exTot.toFixed(2)}</td><td style="font-weight:bold">${inTot.toFixed(2)}</td><td></td></tr>`;
  Sortable.create(tbody,{handle:".sort-handle",onEnd:()=>basket=[...tbody.children].map(r=>basket.find(b=>b.item===r.children[1].textContent))});
}

/* ---------- CSV EXPORT ---------- */
$("#exportCsvBtn").onclick=()=>{
  if(!basket.length)return;
  const lines=[["Item","Quantity","Price Ex. GST","Price Inc. GST","Line Ex","Line Inc"].map(s=>`"${s}"`)];
  let ex=0,inc=0;
  basket.forEach(b=>{
    const le=isNaN(b.ex)?0:b.qty*b.ex, li=isNaN(b.inc)?0:b.qty*b.inc; ex+=le; inc+=li;
    lines.push([b.item,b.qty,isNaN(b.ex)?"N/A":b.ex.toFixed(2),isNaN(b.inc)?"N/A":b.inc.toFixed(2),isNaN(b.ex)?"N/A":le.toFixed(2),isNaN(b.inc)?"N/A":li.toFixed(2)].map(v=>`"${String(v).replace(/"/g,'""')}"`));
  });
  lines.push(['','','',"\"Totals:\"",ex.toFixed(2),inc.toFixed(2)]);
  const blob=new Blob([lines.map(r=>r.join(",")).join("\n")],{type:"text/csv"}); const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="quote_basket.csv";document.body.appendChild(a);a.click();document.body.removeChild(a);
};
})();
</script>
</body>
</html>
